<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fupa Snack - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #ffffff; --secondary-color: #4fc3f7; --accent-color: #29b6f6; --text-color: #333333; --light-text: #666666; --border-color: #e0e0e0; --shadow: 0 2px 10px rgba(0, 0, 0, 0.1); --transition: all 0.3s ease; --danger-color: #f44336; --success-color: #4caf50;
        }
        .dark-mode {
            --primary-color: #1a1a1a; --secondary-color: #0277bd; --accent-color: #0288d1; --text-color: #f5f5f5; --light-text: #b0b0b0; --border-color: #333333; --shadow: 0 2px 10px rgba(0, 0, 0, 0.3); --danger-color: #d32f2f; --success-color: #388e3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--primary-color); color: var(--text-color); line-height: 1.6; transition: var(--transition); overflow-x: hidden; height: 100vh; overflow-y: auto; }
        h1, h2, h3, h4 { font-family: 'Montserrat', sans-serif; font-weight: 600; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .header { background-color: var(--primary-color); padding: 15px 0; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }
        .header-actions { display: flex; gap: 15px; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-color); cursor: pointer; padding: 8px; border-radius: 50%; transition: var(--transition); }
        .icon-btn:hover { background-color: rgba(0, 0, 0, 0.05); }
        .dark-mode .icon-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        .popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition); }
        .popup.active { opacity: 1; visibility: visible; }
        .popup-content { background-color: var(--primary-color); border-radius: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow); transform: translateY(-20px); transition: var(--transition); }
        .popup.active .popup-content { transform: translateY(0); }
        .popup-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .popup-title { font-size: 1.2rem; font-weight: 600; }
        .popup-close { background: none; border: none; font-size: 1.2rem; color: var(--text-color); cursor: pointer; }
        .popup-body { padding: 20px; }
        .menu-list { list-style: none; }
        .menu-item { padding: 12px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: space-between; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:hover { color: var(--accent-color); }
        .menu-item i { margin-right: 10px; width: 20px; text-align: center; }
        .submenu { list-style: none; margin-left: 20px; margin-top: 10px; display: none; }
        .submenu.active { display: block; }
        .submenu-item { padding: 8px 0; cursor: pointer; transition: var(--transition); }
        .submenu-item:hover { color: var(--accent-color); }
        .main-content { padding: 20px 0; min-height: calc(100vh - 70px); overflow-y: auto; }
        .section-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .section-title { font-size: 1.5rem; font-weight: 600; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; white-space: nowrap; scrollbar-width: thin; -webkit-overflow-scrolling: touch; }
        .tabs::-webkit-scrollbar { height: 6px; }
        .tabs::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .tab { padding: 10px 15px; cursor: pointer; border-bottom: 2px solid transparent; transition: var(--transition); -webkit-user-select: none; user-select: none; }
        .tab.active { border-bottom: 2px solid var(--accent-color); color: var(--accent-color); }
        .table-container { overflow-x: auto; margin-bottom: 20px; border-radius: 8px; box-shadow: var(--shadow); max-height: 450px; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; }
        .table-10-rows { max-height: 450px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: rgba(79, 195, 247, 0.1); font-weight: 600; position: sticky; top: 0; z-index: 10; border-top: 1px solid var(--border-color); }
        tr:hover { background-color: rgba(0, 0, 0, 0.02); }
        .dark-mode tr:hover { background-color: rgba(255, 255, 255, 0.05); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--primary-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: var(--transition); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(41, 182, 246, 0.2); }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Inter', sans-serif; font-weight: 500; transition: var(--transition); display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .btn-secondary { background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); }
        .btn-secondary:hover { background-color: rgba(79, 195, 247, 0.1); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #d32f2f; transform: scale(1.05); }
        .filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .filter-group { flex: 1; min-width: 150px; }
        .financial-summary { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .financial-card { background-color: var(--primary-color); border-radius: 8px; padding: 15px; box-shadow: var(--shadow); text-align: center; transition: var(--transition); }
        .financial-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .financial-card h3 { font-size: 0.9rem; margin-bottom: 10px; color: var(--light-text); }
        .financial-card .amount { font-size: 1.5rem; font-weight: 600; color: var(--text-color); }
        .hidden { display: none !important; }
        .text-right { text-align: right; }
        .currency { font-family: 'Inter', sans-serif; }
        @media (min-width: 768px) {
            .header { padding: 20px 0; }
            .logo { font-size: 1.8rem; }
            .main-content { padding: 30px 0; }
            .section-title { font-size: 1.8rem; }
        }
        .content-section { opacity: 1; transition: opacity 0.3s ease; }
        .content-section.hidden { display: none; opacity: 0; }
        .custom-period-group { display: flex; gap: 10px; align-items: flex-end; }
        .custom-period-group .filter-group { flex: 1; }
        #inputDetail table { min-width: 1100px; }
        #inputDetail th, #inputDetail td { padding: 15px 10px; min-width: 100px; }
        #inputDetail input { width: 100%; min-width: 80px; padding: 8px; }
        .action-column { width: 60px; text-align: center; }
        .input-with-btn { display: flex; gap: 10px; }
        .input-with-btn input { flex: 1; }
        .input-with-btn button { white-space: nowrap; }
        .currency-input { position: relative; }
        .currency-input input { padding-left: 40px; }
        .currency-input::before { content: "Rp"; position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--light-text); z-index: 1; }
        .actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .data-card { background-color: var(--primary-color); border-radius: 10px; padding: 20px; box-shadow: var(--shadow); transition: var(--transition); }
        .data-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .data-card h3 { font-size: 1rem; margin-bottom: 15px; color: var(--light-text); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .data-item { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color); }
        .data-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .data-label { font-weight: 500; }
        .data-value { font-weight: 600; color: var(--accent-color); }
        .search-container { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; align-items: center; }
        .search-input { flex: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 5px; background-color: var(--primary-color); color: var(--text-color); max-width: 200px; }
        .detail-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .detail-search-container { display: flex; align-items: center; gap: 10px; }
        #inputDetail th:nth-child(10), #inputDetail td:nth-child(10) { min-width: 150px; width: 150px; }
        #inputDetail th:nth-child(3), #inputDetail td:nth-child(3) { min-width: 200px; }
        #inputDetail th:nth-child(4), #inputDetail td:nth-child(4) { min-width: 200px; }
        #inputDetail th:nth-child(8), #inputDetail td:nth-child(8),
        #inputDetail th:nth-child(9), #inputDetail td:nth-child(9) { min-width: 150px; }
        .fullscreen-popup { max-width: 95% !important; max-height: 95% !important; width: 95% !important; height: 95% !important; }
        .fullscreen-popup .popup-body { height: calc(100% - 70px); display: flex; flex-direction: column; }
        .fullscreen-table-container { flex: 1; overflow: auto; }
        #loginPopup .popup-content { max-width: 350px; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .login-logo { text-align: center; margin-bottom: 20px; font-size: 2rem; color: var(--accent-color); font-weight: 700; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn.loading { pointer-events: none; opacity: 0.7; }
        .login-footer { text-align: center; margin-top: 20px; font-size: 0.9rem; color: var(--light-text); }
        .user-info { display: flex; align-items: center; gap: 10px; margin-right: 15px; }
        .user-role { font-size: 0.8rem; color: var(--light-text); padding: 2px 8px; background-color: var(--border-color); border-radius: 10px; }
        .control-buttons { display: flex; gap: 5px; align-items: center; }
        .control-btn { background-color: var(--accent-color); color: white; border: none; border-radius: 5px; padding: 8px 12px; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 5px; }
        .control-btn:hover { background-color: var(--secondary-color); }
        .edit-mode .table-container input:not([readonly]) { background-color: rgba(79, 195, 247, 0.1); border-color: var(--accent-color); }
        .supplier-popup table { min-width: 800px; }
        .btn-success { background-color: var(--success-color) !important; }
        .btn-success:hover { background-color: #388e3c !important; }
        .global-edit-mode .table-container input:not([readonly]) { background-color: rgba(79, 195, 247, 0.1); border-color: var(--accent-color); }
        
        /* Absensi Styles */
        .absensi-container { max-width: 900px; margin: 0 auto; }
        .absensi-note { background-color: rgba(255, 248, 225, 0.8); padding: 15px; border-left: 4px solid #ffb300; margin-bottom: 20px; border-radius: 5px; }
        .dark-mode .absensi-note { background-color: rgba(255, 248, 225, 0.1); }
        .absensi-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .absensi-status { margin: 10px 0; padding: 10px; border-radius: 5px; background-color: rgba(79, 195, 247, 0.1); }
        .absensi-tepat { color: #1b5e20; font-weight: 600; }
        .absensi-terlambat { color: #f57c00; font-weight: 600; }
        .absensi-invalid { color: #b71c1c; font-weight: 600; }
        .absensi-ok { color: #1b5e20; font-weight: 600; }
        .absensi-flag { color: #b71c1c; font-weight: 600; }
        #photoPreview { max-width: 200px; margin-top: 10px; display: none; border-radius: 5px; border: 2px solid var(--border-color); }
        #randomCode { font-family: monospace; font-size: 18px; background: var(--border-color); padding: 5px 10px; display: inline-block; margin-left: 10px; border-radius: 3px; }
        .ip-info { font-size: 12px; color: var(--light-text); margin: 5px 0; }
        .absensi-log-table { margin-top: 20px; }
        .absensi-log-table th, .absensi-log-table td { padding: 8px; font-size: 13px; }
        #cameraInput { display: none; }
        .countdown-display { font-weight: 600; color: var(--accent-color); }
        .location-display { background: var(--border-color); padding: 8px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
        .photo-preview-container { text-align: center; margin: 15px 0; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Admin Geofence Monitor Styles */
        .admin-geofence-container { max-width: 1200px; margin: 0 auto; }
        .admin-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .admin-filters { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
        .admin-filter-group { display: flex; align-items: center; gap: 6px; }
        .admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000; }
        .admin-modal.active { display: flex; }
        .admin-modal-content { background: var(--primary-color); padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: var(--shadow); }
        .admin-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .admin-modal-body { display: flex; flex-direction: column; gap: 12px; }
        .admin-close-btn { cursor: pointer; font-size: 24px; color: var(--text-color); }
        .admin-table-container { max-height: 500px; overflow-y: auto; }
        .admin-table th, .admin-table td { padding: 8px; font-size: 13px; text-align: left; }
        .admin-table th { background-color: rgba(79, 195, 247, 0.1); position: sticky; top: 0; }
    </style>
</head>
<body>
    <div class="popup active" id="loginPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Login</h3>
            </div>
            <div class="popup-body">
                <div class="login-logo">Fupa Snack</div>
                <form class="login-form" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Masukkan email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Masukkan password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        <span id="loginText">Login</span>
                    </button>
                </form>
                <div class="login-footer" id="loginFooter">Gunakan email dan password yang telah diberikan</div>
            </div>
        </div>
    </div>

    <header class="header hidden" id="mainHeader">
        <div class="container">
            <div class="header-content">
                <div class="logo">Fupa Snack</div>
                <div style="display: flex; align-items: center;">
                    <div class="user-info hidden" id="userInfo">
                        <span id="userName"></span>
                        <span class="user-role" id="userRole"></span>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn" id="menuBtn"><i class="fas fa-bars"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content hidden" id="mainContent">
        <div class="container">
            <div class="section-header" id="dynamicHeader">
                <h1 class="section-title" id="pageTitle">Dashboard</h1>
                <div class="tabs" id="tabNavigation"></div>
            </div>

            <div id="contentContainer">
                <div class="content-section" id="defaultContent">
                    <p>Selamat datang di dashboard Fupa Snack. Pilih menu untuk mulai.</p>
                </div>

                <div class="content-section hidden" id="inputRingkas">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchRingkas" placeholder="Cari nama supplier atau barang...">
                        <div class="control-buttons">
                            <button class="control-btn" id="editBatchRingkas" title="Edit Batch"><i class="fas fa-edit"></i></button>
                            <button class="control-btn" id="zoomOutRingkas"><i class="fas fa-search-minus"></i></button>
                            <button class="control-btn" id="zoomInRingkas"><i class="fas fa-search-plus"></i></button>
                        </div>
                    </div>
                    <div class="table-container table-10-rows">
                        <table id="tableRingkas">
                            <thead>
                                <tr>
                                    <th>Nama Supplier</th>
                                    <th>Barang</th>
                                    <th style="width: 100px;">Stok</th>
                                    <th style="width: 100px;">Sisa</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="content-section hidden" id="inputDetail">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchDetail" placeholder="Cari nama supplier atau barang">
                        <div class="control-buttons">
                            <button class="control-btn" id="editBatchDetail" title="Edit Batch"><i class="fas fa-edit"></i></button>
                            <button class="control-btn" id="supplierPopupDetail" title="Supplier"><i class="fas fa-truck"></i></button>
                        </div>
                        <button class="btn btn-primary small-add-btn" id="tambahEntri"><i class="fas fa-plus"></i></button>
                    </div>
                    
                    <div class="table-container table-10-rows">
                        <table id="tableDetail">
                            <thead>
                                <tr>
                                    <th class="action-column">Aksi</th>
                                    <th>Tanggal</th>
                                    <th>Nama Supplier</th>
                                    <th>Barang</th>
                                    <th>Stok</th>
                                    <th>Sisa</th>
                                    <th>Terjual</th>
                                    <th>Harga Beli</th>
                                    <th>Harga Jual</th>
                                    <th style="min-width: 150px;">Uang Supplier</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="content-section hidden" id="inputSupplier">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchSupplier" placeholder="Cari nama supplier...">
                        <div class="control-buttons">
                            <button class="control-btn" id="zoomOutSupplier"><i class="fas fa-search-minus"></i></button>
                            <button class="control-btn" id="zoomInSupplier"><i class="fas fa-search-plus"></i></button>
                            <button class="control-btn" id="infoSupplierBtn"><i class="fas fa-question"></i></button>
                        </div>
                    </div>
                    <div class="table-container table-10-rows">
                        <table id="tableSupplier">
                            <thead>
                                <tr>
                                    <th>Nama Supplier</th>
                                    <th>Total Uang Supplier</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="content-section hidden" id="laporanRingkas">
                    <div class="filters">
                        <div class="filter-group">
                            <label for="periodeRingkas">Periode</label>
                            <select id="periodeRingkas">
                                <option value="harian">Hari Ini</option>
                                <option value="mingguan">Minggu Ini</option>
                                <option value="bulanan">Bulan Ini</option>
                                <option value="custom">Periode</option>
                            </select>
                        </div>
                        <div class="filter-group hidden" id="customPeriodRingkas">
                            <label for="tanggalMulaiRingkas">Tanggal Mulai</label>
                            <input type="date" id="tanggalMulaiRingkas">
                        </div>
                        <div class="filter-group hidden" id="customPeriodRingkas2">
                            <label for="tanggalSelesaiRingkas">Tanggal Selesai</label>
                            <input type="date" id="tanggalSelesaiRingkas">
                        </div>
                    </div>
                    
                    <div class="financial-summary">
                        <div class="financial-card">
                            <h3>Total Terjual</h3>
                            <div class="amount" id="totalTerjual">0</div>
                        </div>
                        <div class="financial-card">
                            <h3>Omzet</h3>
                            <div class="amount" id="totalOmzet">Rp 0</div>
                        </div>
                        <div class="financial-card">
                            <h3>Laba Kotor</h3>
                            <div class="amount" id="totalLabaKotor">Rp 0</div>
                        </div>
                    </div>
                    
                    <div class="card-container" id="karyawanCards"></div>
                </div>

                <div class="content-section hidden" id="inputAbsensi">
                    <div class="absensi-container">
                        <h3>Absensi Geofence</h3>
                        <div class="absensi-note">
                            <strong>Aturan Presensi:</strong><br>
                            - Hanya sekali presensi per hari<br>
                            - Waktu presensi: 05.00-05.30 (tepat), 05.31-05.45 (terlambat), 14.30-15.00 (tepat), 15.01-15.15 (terlambat)<br>
                            - Diluar waktu tersebut tidak dapat presensi<br>
                            - Harus mengambil foto terlebih dahulu sebelum absen
                        </div>

                        <div class="absensi-controls">
                            <button class="btn btn-primary" id="absenBtn" disabled>Absen Sekarang</button>
                            <button class="btn btn-secondary" id="takePhotoBtn">Ambil Foto</button>
                        </div>

                        <div class="photo-preview-container">
                            <img id="photoPreview" alt="Preview foto">
                            <div><small>Foto akan disimpan ke log absensi (maks 20KB)</small></div>
                        </div>

                        <div class="absensi-status" id="absensiStatus">Status: Ambil foto terlebih dahulu.</div>
                        
                        <div id="randomCode"></div>

                        <div class="ip-info">
                            <strong>IP Geolocation (coarse):</strong> <span id="ipInfo">belum dimuat</span>
                        </div>

                        <div class="location-display">
                            <strong>Lokasi Kantor Anda:</strong> <span id="lokasiKantorInfo">Memuat...</span>
                        </div>

                        <div class="table-container absensi-log-table">
                            <table id="absensiLogTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tanggal</th>
                                        <th>Waktu</th>
                                        <th>Status</th>
                                        <th>Lat, Lon</th>
                                        <th>Dist (m)</th>
                                        <th>Akurasi (m)</th>
                                        <th>IP</th>
                                        <th>Flags</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <input type="file" id="cameraInput" accept="image/*" capture="environment">
                    </div>
                </div>

                <!-- Laporan Kehadiran Admin -->
                <div class="content-section hidden" id="laporanKehadiranAdmin">
                    <div class="admin-geofence-container">
                        <h3>Monitor Kehadiran Admin</h3>
                        
                        <div class="admin-controls">
                            <button id="deleteLogBtn" class="btn btn-danger">Hapus Bulan Lalu</button>
                            <button id="downloadBtn" class="btn btn-secondary">Unduh CSV</button>
                        </div>

                        <div class="admin-filters">
                            <div class="admin-filter-group">
                                <label>Filter:</label>
                                <select id="filterNama">
                                    <option value="">Semua</option>
                                </select>
                            </div>
                            
                            <div class="admin-filter-group">
                                <label>Periode:</label>
                                <select id="filterPeriode">
                                    <option value="hari_ini">Hari Ini</option>
                                    <option value="bulan_ini">Bulan Ini</option>
                                    <option value="periode">Periode</option>
                                </select>
                            </div>
                            
                            <div class="admin-filter-group" id="periodeInputs" style="display:none;">
                                <input type="date" id="startDate">
                                <span>s/d</span>
                                <input type="date" id="endDate">
                            </div>
                        </div>

                        <div class="table-container admin-table-container">
                            <table id="logTable" class="admin-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tanggal</th>
                                        <th>Waktu</th>
                                        <th>Nama</th>
                                        <th>Status</th>
                                        <th>Foto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data akan dimuat dari Firestore -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="popup" id="menuPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Menu</h3>
                <button class="popup-close" id="closeMenu"><i class="fas fa-times"></i></button>
            </div>
            <div class="popup-body">
                <ul class="menu-list" id="menuList">
                    <!-- Menu akan diisi berdasarkan role user -->
                </ul>
            </div>
        </div>
    </div>

    <div class="popup" id="supplierInfoPopup">
        <div class="popup-content fullscreen-popup">
            <div class="popup-header">
                <h3 class="popup-title">Detail Uang Supplier</h3>
                <button class="popup-close" id="closeSupplierInfo"><i class="fas fa-times"></i></button>
            </div>
            <div class="popup-body">
                <div class="table-container fullscreen-table-container">
                    <table id="tableSupplierDetail">
                        <thead>
                            <tr>
                                <th class="action-column">Aksi</th>
                                <th>Tanggal</th>
                                <th>Nama</th>
                                <th>Belum Dibayar</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="actions" style="margin-top: 15px;">
                    <button class="btn btn-primary" id="tambahEntriSupplier"><i class="fas fa-plus"></i> Tambah Entri</button>
                </div>
            </div>
        </div>
    </div>

    <div class="popup" id="supplierMasterPopup">
        <div class="popup-content fullscreen-popup">
            <div class="popup-header">
                <h3 class="popup-title">Master Supplier</h3>
                <button class="popup-close" id="closeSupplierMaster"><i class="fas fa-times"></i></button>
            </div>
            <div class="popup-body">
                <div class="actions" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <button class="btn btn-primary" id="pasteSelectedSupplier"><i class="fas fa-paste"></i> Paste ke Detail</button>
                        <button class="btn btn-danger" id="deleteSelectedSupplier"><i class="fas fa-trash"></i> Hapus Terpilih</button>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="editBatchSupplierMaster"><i class="fas fa-edit"></i> Edit Batch</button>
                        <button class="btn btn-primary" id="tambahSupplierMaster"><i class="fas fa-plus"></i> Tambah Supplier</button>
                    </div>
                </div>
                <div class="table-container fullscreen-table-container">
                    <table id="tableSupplierMaster" class="supplier-popup">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th>Nama Supplier</th>
                                <th>Barang</th>
                                <th>Harga Beli</th>
                                <th>Harga Jual</th>
                                <th class="action-column">Aksi</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (UPDATED)
        const firebaseConfig = {
            apiKey: "AIzaSyCP9CCaVgti8Iz2CG8m_mcXAr-dSSZ9KVo",
            authDomain: "fupasnack1.firebaseapp.com",
            projectId: "fupasnack1",
            storageBucket: "fupasnack1.firebasestorage.app",
            messagingSenderId: "1053804570791",
            appId: "1:1053804570791:web:edb758044ed7d6bda51382"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Cloudinary Configuration
        const CLOUDINARY_CLOUD_NAME = 'dn2o2vf04';
        const CLOUDINARY_UPLOAD_PRESET = 'presensi_unsigned';

        // Global Variables
        let currentUser = null;
        let userRole = null;
        let salesData = [];
        let supplierData = [];
        let belumDibayarData = [];
        let supplierMasterData = [];
        let isGlobalEditMode = false; // Status edit mode global
        let batchChanges = {
            ringkas: new Map(), // key: supplier-barang, value: {stok, sisa}
            detail: new Map(),   // key: saleId, value: {field: value}
            supplierMaster: new Map() // key: supplierMasterId, value: {field: value}
        };
        let selectedSupplierIds = new Set();

        // Absensi Variables
        let currentPhoto = null;
        let randomCodeInterval = null;
        let ipGeo = null;
        let kantorLocation = null;
        const PRESENSI_WAKTU = {
            pagi: { start: 5 * 60, tepat: 5 * 60 + 30, akhir: 5 * 60 + 45 }, // 05:00-05:30 tepat, 05:31-05:45 terlambat
            siang: { start: 14 * 60 + 30, tepat: 15 * 60, akhir: 15 * 60 + 15 } // 14:30-15:00 tepat, 15:01-15:15 terlambat
        };

        // Admin Geofence Variables
        let allAbsensiData = [];

        // DOM Elements
        const loginPopup = document.getElementById('loginPopup');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginFooter = document.getElementById('loginFooter');
        const mainHeader = document.getElementById('mainHeader');
        const mainContent = document.getElementById('mainContent');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const userRoleElement = document.getElementById('userRole');
        const menuBtn = document.getElementById('menuBtn');
        const menuPopup = document.getElementById('menuPopup');
        const menuList = document.getElementById('menuList');
        const closeMenu = document.getElementById('closeMenu');
        const pageTitle = document.getElementById('pageTitle');
        const tabNavigation = document.getElementById('tabNavigation');
        const contentContainer = document.getElementById('contentContainer');
        const allContentSections = document.querySelectorAll('.content-section');
        const tambahEntriBtn = document.getElementById('tambahEntri');
        
        // Absensi DOM Elements
        const absenBtn = document.getElementById('absenBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const photoPreview = document.getElementById('photoPreview');
        const cameraInput = document.getElementById('cameraInput');
        const absensiStatus = document.getElementById('absensiStatus');
        const randomCodeEl = document.getElementById('randomCode');
        const ipInfoEl = document.getElementById('ipInfo');
        const lokasiKantorInfo = document.getElementById('lokasiKantorInfo');
        const absensiLogTable = document.querySelector('#absensiLogTable tbody');

        // Admin Geofence DOM Elements
        const deleteLogBtn = document.getElementById('deleteLogBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const filterNama = document.getElementById('filterNama');
        const filterPeriode = document.getElementById('filterPeriode');
        const periodeInputs = document.getElementById('periodeInputs');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const logTableBody = document.querySelector('#logTable tbody');

        const currentZoomLevels = { ringkas: 1, detail: 1, supplier: 1, supplierPopup: 1 };
        const minZoomLevel = 0.5, maxZoomLevel = 2, zoomStep = 0.1;
        let isTabKeyPressed = false;
        let currentTabs = [];

        // PERBAIKAN: Menambahkan variabel untuk menyimpan urutan paste
        let selectedSupplierOrder = [];

        // Utility Functions
        const capitalizeFirstLetter = string => string.charAt(0).toUpperCase() + string.slice(1);
        const formatCurrency = amount => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const formatNumber = number => new Intl.NumberFormat('id-ID').format(number);
        const parseCurrency = value => typeof value === 'string' ? parseInt(value.replace(/[^\d]/g, '')) || 0 : value || 0;
        const getPageTitle = contentId => ({ 
            'inputPenjualan': 'Input Penjualan', 
            'laporanRingkas': 'Laporan Keuangan Ringkas',
            'inputAbsensi': 'Input Absensi',
            'laporanKehadiranAdmin': 'Laporan Kehadiran Admin'
        }[contentId] || 'Dashboard');
        const getTabLabel = tab => ({ 'ringkas': 'Ringkas', 'detail': 'Detail', 'supplier': 'Uang Supplier' }[tab] || tab);
        const getToday = () => new Date().toISOString().split('T')[0];
        
        const getTodaySalesData = () => {
            const today = getToday();
            return salesData.filter(item => item.tanggal === today);
        };

        const calculateSalesMetrics = (stok, sisa, hargaBeli, hargaJual) => {
            const terjual = stok - sisa;
            const uangSupplier = terjual * hargaBeli;
            const labaKotor = terjual * (hargaJual - hargaBeli);
            const omzet = terjual * hargaJual;
            
            return { terjual, uangSupplier, labaKotor, omzet };
        };

        const getFilteredSalesData = () => {
            const periode = document.getElementById('periodeRingkas').value;
            const tanggalMulai = document.getElementById('tanggalMulaiRingkas').value;
            const tanggalSelesai = document.getElementById('tanggalSelesaiRingkas').value;
            
            let filteredData = [...salesData];
            
            const today = new Date();
            today.setHours(0,0,0,0);

            switch (periode) {
                case 'harian':
                    filteredData = filteredData.filter(item => item.tanggal === getToday());
                    break;
                case 'mingguan':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    startOfWeek.setHours(0,0,0,0);
                    
                    const endOfWeek = new Date(today);
                    endOfWeek.setDate(today.getDate() + (6 - today.getDay()));
                    endOfWeek.setHours(23,59,59,999);
                    
                    filteredData = filteredData.filter(item => {
                        const itemDate = new Date(item.tanggal);
                        return itemDate >= startOfWeek && itemDate <= endOfWeek;
                    });
                    break;
                case 'bulanan':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    endOfMonth.setHours(23,59,59,999);
                    
                    filteredData = filteredData.filter(item => {
                        const itemDate = new Date(item.tanggal);
                        return itemDate >= startOfMonth && itemDate <= endOfMonth;
                    });
                    break;
                case 'custom':
                    if (tanggalMulai && tanggalSelesai) {
                        const startCustom = new Date(tanggalMulai);
                        startCustom.setHours(0,0,0,0);
                        const endCustom = new Date(tanggalSelesai);
                        endCustom.setHours(23,59,59,999);
                        
                        filteredData = filteredData.filter(item => {
                            const itemDate = new Date(item.tanggal);
                            return itemDate >= startCustom && itemDate <= endCustom;
                        });
                    }
                    break;
                default:
                    break;
            }
            
            return filteredData;
        };

        // Authentication Functions
        const loginWithEmailPassword = async (email, password) => {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                return userCredential.user;
            } catch (error) {
                throw error;
            }
        };

        const logoutUser = async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout error:", error);
            }
        };

        const getUserData = async (uid) => {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    return userDoc.data();
                } else {
                    const userData = {
                        nama: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        role: 'Karyawan'
                    };
                    await db.collection('users').doc(uid).set(userData);
                    return userData;
                }
            } catch (error) {
                console.error("Error getting user data:", error);
                throw error;
            }
        };

        // Firestore CRUD Operations
        const addSale = async (saleData) => {
            try {
                const { stok, sisa, hargaBeli, hargaJual } = saleData;
                const { terjual, uangSupplier, labaKotor, omzet } = calculateSalesMetrics(stok, sisa, hargaBeli, hargaJual);
                
                const saleWithCalculations = {
                    ...saleData,
                    terjual,
                    uangSupplier,
                    labaKotor,
                    omzet,
                    nama: currentUser.nama,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('sales').add(saleWithCalculations);
                return docRef.id;
            } catch (error) {
                console.error("Error adding sale:", error);
                throw error;
            }
        };

        const updateSale = async (id, saleData) => {
            try {
                const today = getToday();
                const sale = salesData.find(item => item.id === id);
                
                if (sale && sale.tanggal !== today) {
                    alert("Tidak dapat mengupdate data yang bukan hari ini.");
                    throw new Error("Update hanya diizinkan untuk data hari ini.");
                }

                const { stok, sisa, hargaBeli, hargaJual } = saleData;
                const { terjual, uangSupplier, labaKotor, omzet } = calculateSalesMetrics(stok, sisa, hargaBeli, hargaJual);
                
                const saleWithCalculations = {
                    ...saleData,
                    terjual,
                    uangSupplier,
                    labaKotor,
                    omzet,
                    nama: currentUser.nama,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('sales').doc(id).update(saleWithCalculations);
            } catch (error) {
                console.error("Error updating sale:", error);
                throw error;
            }
        };

        const updateSalesBatch = async (updates) => {
            try {
                const batch = db.batch();
                const today = getToday();
                
                for (const [id, data] of updates) {
                    const sale = salesData.find(item => item.id === id);
                    if (sale && sale.tanggal !== today) {
                        alert(`Tidak dapat mengupdate data ${id} yang bukan hari ini.`);
                        continue;
                    }
                    
                    const saleRef = db.collection('sales').doc(id);
                    const { stok, sisa, hargaBeli, hargaJual, ...rest } = data;
                    const { terjual, uangSupplier, labaKotor, omzet } = calculateSalesMetrics(stok, sisa, hargaBeli, hargaJual);
                    
                    batch.update(saleRef, {
                        ...rest,
                        stok, sisa, hargaBeli, hargaJual,
                        terjual, uangSupplier, labaKotor, omzet,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                return true;
            } catch (error) {
                console.error("Error updating batch:", error);
                throw error;
            }
        };

        const updateRingkasBatch = async (updates) => {
            try {
                const today = getToday();
                const batch = db.batch();
                
                for (const [key, data] of updates) {
                    const [supplier, barang] = key.split('-');
                    const matchingSales = salesData.filter(item => 
                        item.supplier === supplier && 
                        item.barang === barang && 
                        item.tanggal === today
                    );
                    
                    for (const sale of matchingSales) {
                        const updatedData = { ...sale };
                        updatedData.stok = data.stok;
                        updatedData.sisa = data.sisa;
                        
                        const { terjual, uangSupplier, labaKotor, omzet } = calculateSalesMetrics(
                            updatedData.stok, 
                            updatedData.sisa, 
                            updatedData.hargaBeli, 
                            updatedData.hargaJual
                        );
                        
                        updatedData.terjual = terjual;
                        updatedData.uangSupplier = uangSupplier;
                        updatedData.labaKotor = labaKotor;
                        updatedData.omzet = omzet;
                        
                        const saleRef = db.collection('sales').doc(sale.id);
                        batch.update(saleRef, {
                            ...updatedData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                await batch.commit();
                return true;
            } catch (error) {
                console.error("Error updating ringkas batch:", error);
                throw error;
            }
        };

        const updateSupplierMasterBatch = async (updates) => {
            try {
                const batch = db.batch();
                
                for (const [id, data] of updates) {
                    const supplierRef = db.collection('supplierMaster').doc(id);
                    batch.update(supplierRef, {
                        ...data,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                return true;
            } catch (error) {
                console.error("Error updating supplier master batch:", error);
                throw error;
            }
        };

        const deleteSale = async (id) => {
            try {
                await db.collection('sales').doc(id).delete();
            } catch (error) {
                console.error("Error deleting sale:", error);
                throw error;
            }
        };

        const getSales = async () => {
            try {
                let query = db.collection('sales');
                
                if (userRole === 'Karyawan') {
                    query = query.where('createdBy', '==', currentUser.uid);
                }
                
                // PERBAIKAN: Mengurutkan berdasarkan createdAt descending agar terbaru di atas
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                salesData = [];
                snapshot.forEach(doc => {
                    salesData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                return salesData;
            } catch (error) {
                console.error("Error getting sales:", error);
                throw error;
            }
        };

        const getSupplierPayments = async () => {
            try {
                let query = db.collection('belumDibayar');
                
                if (userRole === 'Karyawan') {
                    query = query.where('createdBy', '==', currentUser.uid);
                }
                
                const snapshot = await query.orderBy('tanggal', 'desc').get();
                belumDibayarData = [];
                snapshot.forEach(doc => {
                    belumDibayarData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                return belumDibayarData;
            } catch (error) {
                console.error("Error getting supplier payments:", error);
                throw error;
            }
        };

        const addSupplierPayment = async (data) => {
            try {
                const docRef = await db.collection('belumDibayar').add({
                    ...data,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error("Error adding supplier payment:", error);
                throw error;
            }
        };

        const deleteSupplierPayment = async (id) => {
            try {
                await db.collection('belumDibayar').doc(id).delete();
            } catch (error) {
                console.error("Error deleting supplier payment:", error);
                throw error;
            }
        };

        // SupplierMaster functions dengan createdBy
        const getSupplierMaster = async () => {
            try {
                let query = db.collection('supplierMaster');
                
                // Admin dapat melihat semua data, karyawan hanya data miliknya
                if (userRole === 'Karyawan') {
                    query = query.where('createdBy', '==', currentUser.uid);
                }
                
                // PERBAIKAN: Mengurutkan berdasarkan createdAt descending agar terbaru di atas
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                supplierMasterData = [];
                snapshot.forEach(doc => {
                    supplierMasterData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                return supplierMasterData;
            } catch (error) {
                console.error("Error getting supplier master:", error);
                throw error;
            }
        };

        const addSupplierMaster = async (data) => {
            try {
                const docRef = await db.collection('supplierMaster').add({
                    ...data,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error("Error adding supplier master:", error);
                throw error;
            }
        };

        const updateSupplierMaster = async (id, data) => {
            try {
                await db.collection('supplierMaster').doc(id).update({
                    ...data,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating supplier master:", error);
                throw error;
            }
        };

        const deleteSupplierMaster = async (id) => {
            try {
                await db.collection('supplierMaster').doc(id).delete();
            } catch (error) {
                console.error("Error deleting supplier master:", error);
                throw error;
            }
        };

        const deleteSupplierMasterBatch = async (ids) => {
            try {
                const batch = db.batch();
                ids.forEach(id => {
                    const docRef = db.collection('supplierMaster').doc(id);
                    batch.delete(docRef);
                });
                await batch.commit();
                return true;
            } catch (error) {
                console.error("Error deleting supplier master batch:", error);
                throw error;
            }
        };

        // Absensi Functions - DIPERBARUI SESUAI PERINTAH
        const getKantorLocation = async () => {
            try {
                // Cari dokumen di koleksi lokasiKantor dengan createdBy yang sesuai dengan UID user
                const querySnapshot = await db.collection('lokasiKantor')
                    .where('createdBy', '==', currentUser.uid)
                    .limit(1)
                    .get();
                
                if (!querySnapshot.empty) {
                    // Jika dokumen ditemukan, ambil data dari dokumen pertama
                    const doc = querySnapshot.docs[0];
                    kantorLocation = doc.data();
                    kantorLocation.id = doc.id; // Simpan ID dokumen
                    
                    console.log('Lokasi kantor ditemukan:', kantorLocation);
                    return kantorLocation;
                } else {
                    // Jika belum ada dokumen, buat dokumen baru
                    console.log('Membuat lokasi kantor baru untuk user:', currentUser.uid);
                    
                    const defaultLocation = {
                        lokasiCabang: {
                            lat: -6.901148,
                            lon: 109.402953,
                            radius: 100
                        },
                        namaCabang: 'Kantor Pusat Fupa Snack',
                        createdBy: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Buat dokumen baru di koleksi lokasiKantor
                    const docRef = await db.collection('lokasiKantor').add(defaultLocation);
                    
                    // Simpan ID dokumen yang baru dibuat
                    defaultLocation.id = docRef.id;
                    kantorLocation = defaultLocation;
                    
                    console.log('Lokasi kantor berhasil dibuat:', kantorLocation);
                    return kantorLocation;
                }
            } catch (error) {
                console.error("Error getting kantor location:", error);
                
                // Jika error, gunakan lokasi default sementara
                kantorLocation = {
                    lokasiCabang: {
                        lat: -6.901148,
                        lon: 109.402953,
                        radius: 100
                    },
                    namaCabang: 'Kantor Pusat Fupa Snack',
                    createdBy: currentUser.uid
                };
                
                console.log('Menggunakan lokasi default karena error:', kantorLocation);
                return kantorLocation;
            }
        };

        const getAbsensiData = async () => {
            try {
                let query = db.collection('absensi');
                
                // Setiap user hanya bisa melihat data miliknya sendiri
                query = query.where('createdBy', '==', currentUser.uid);
                
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                const absensiData = [];
                snapshot.forEach(doc => {
                    absensiData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                return absensiData;
            } catch (error) {
                console.error("Error getting absensi data:", error);
                throw error;
            }
        };

        // Function untuk admin mendapatkan semua data absensi
        const getAllAbsensiData = async () => {
            try {
                const snapshot = await db.collection('absensi').orderBy('createdAt', 'desc').get();
                allAbsensiData = [];
                snapshot.forEach(doc => {
                    allAbsensiData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                return allAbsensiData;
            } catch (error) {
                console.error("Error getting all absensi data:", error);
                throw error;
            }
        };

        const addAbsensi = async (absensiData) => {
            try {
                const docRef = await db.collection('absensi').add({
                    ...absensiData,
                    nama: currentUser.nama,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error("Error adding absensi:", error);
                throw error;
            }
        };

        // Image Compression and Upload Functions - DIPERBARUI untuk maksimal 20KB
        const compressImage = (file, maxSizeKB = 20) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate new dimensions
                        let width = img.width;
                        let height = img.height;
                        const maxDimension = 800;
                        
                        if (width > height && width > maxDimension) {
                            height *= maxDimension / width;
                            width = maxDimension;
                        } else if (height > maxDimension) {
                            width *= maxDimension / height;
                            height = maxDimension;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Try different quality levels to get under maxSizeKB (20KB)
                        let quality = 0.7;
                        let compressedDataUrl;
                        let sizeKB = 0;
                        
                        // Turunkan kualitas hingga mencapai di bawah 20KB
                        for (let q = quality; q > 0.1; q -= 0.1) {
                            compressedDataUrl = canvas.toDataURL('image/jpeg', q);
                            sizeKB = (compressedDataUrl.length * 0.75) / 1024;
                            if (sizeKB <= maxSizeKB) {
                                console.log(`Kompresi berhasil: ${sizeKB.toFixed(2)}KB dengan kualitas ${q}`);
                                break;
                            }
                        }
                        
                        // Jika masih di atas 20KB, kurangi dimensi lebih jauh
                        if (sizeKB > maxSizeKB) {
                            console.log('Ukuran masih di atas 20KB, mengurangi dimensi...');
                            // Kurangi dimensi hingga 30% dari ukuran asli
                            for (let scale = 0.9; scale > 0.3; scale -= 0.1) {
                                canvas.width = width * scale;
                                canvas.height = height * scale;
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                
                                // Gunakan kualitas rendah untuk kompresi maksimal
                                compressedDataUrl = canvas.toDataURL('image/jpeg', 0.3);
                                sizeKB = (compressedDataUrl.length * 0.75) / 1024;
                                if (sizeKB <= maxSizeKB) {
                                    console.log(`Kompresi berhasil setelah skala ${scale}: ${sizeKB.toFixed(2)}KB`);
                                    break;
                                }
                            }
                        }
                        
                        // Validasi akhir: harus di bawah 20KB
                        sizeKB = (compressedDataUrl.length * 0.75) / 1024;
                        if (sizeKB > maxSizeKB) {
                            // Gunakan kualitas terendah dan dimensi minimal
                            canvas.width = width * 0.3;
                            canvas.height = height * 0.3;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            compressedDataUrl = canvas.toDataURL('image/jpeg', 0.1);
                            sizeKB = (compressedDataUrl.length * 0.75) / 1024;
                            
                            if (sizeKB > maxSizeKB) {
                                reject(new Error(`Gagal mengompresi di bawah ${maxSizeKB}KB. Ukuran akhir: ${sizeKB.toFixed(2)}KB`));
                            } else {
                                console.log(`Kompresi darurat berhasil: ${sizeKB.toFixed(2)}KB`);
                                resolve(compressedDataUrl);
                            }
                        } else {
                            resolve(compressedDataUrl);
                        }
                    };
                    
                    img.onerror = reject;
                };
                
                reader.onerror = reject;
            });
        };

        const uploadToCloudinary = async (compressedImage) => {
            try {
                const formData = new FormData();
                const blob = dataURLtoBlob(compressedImage);
                
                // Validasi ukuran sebelum upload (maksimal 20KB)
                const sizeKB = blob.size / 1024;
                if (sizeKB > 20) {
                    throw new Error(`Ukuran gambar ${sizeKB.toFixed(2)}KB melebihi batas 20KB`);
                }
                
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Error uploading to Cloudinary:", error);
                throw error;
            }
        };

        const dataURLtoBlob = (dataURL) => {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            
            return new Blob([u8arr], { type: mime });
        };

        // Geolocation Utilities
        const toRad = (deg) => deg * Math.PI / 180;
        
        const distanceMeters = (lat1, lon1, lat2, lon2) => {
            const R = 6371000;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const getPresensiStatus = (date) => {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const totalMinutes = hours * 60 + minutes;
            
            // Cek waktu pagi
            if (totalMinutes >= PRESENSI_WAKTU.pagi.start && totalMinutes <= PRESENSI_WAKTU.pagi.tepat) {
                return { status: 'tepat', jenis: 'pagi' };
            }
            if (totalMinutes > PRESENSI_WAKTU.pagi.tepat && totalMinutes <= PRESENSI_WAKTU.pagi.akhir) {
                return { status: 'terlambat', jenis: 'pagi' };
            }
            
            // Cek waktu siang
            if (totalMinutes >= PRESENSI_WAKTU.siang.start && totalMinutes <= PRESENSI_WAKTU.siang.tepat) {
                return { status: 'tepat', jenis: 'siang' };
            }
            if (totalMinutes > PRESENSI_WAKTU.siang.tepat && totalMinutes <= PRESENSI_WAKTU.siang.akhir) {
                return { status: 'terlambat', jenis: 'siang' };
            }
            
            return { status: 'invalid', jenis: null };
        };

        const formatDate = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatDateTime = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        };

        const getCurrentMonth = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        };

        const sudahPresensiHariIni = async () => {
            const today = formatDate(new Date());
            try {
                const absensiData = await getAbsensiData();
                return absensiData.some(item => formatDate(new Date(item.createdAt.seconds * 1000)) === today);
            } catch (error) {
                console.error("Error checking presensi:", error);
                return false;
            }
        };

        const validasiWaktuPresensi = () => {
            const now = new Date();
            const presensiInfo = getPresensiStatus(now);
            
            if (presensiInfo.status === 'invalid') {
                return { 
                    valid: false, 
                    message: 'Presensi hanya bisa dilakukan pada waktu 05.00-05.45 dan 14.30-15.15' 
                };
            }
            
            return { 
                valid: true, 
                data: presensiInfo,
                waktu: now
            };
        };

        const fetchIpGeo = async () => {
            ipInfoEl.textContent = 'memuat...';
            try {
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error('gagal ambil IP');
                const j = await res.json();
                ipGeo = {
                    ip: j.ip || null,
                    lat: j.latitude || null,
                    lon: j.longitude || null,
                    city: j.city || null,
                    region: j.region || null,
                    country: j.country_name || null
                };
                ipInfoEl.textContent = `${ipGeo.ip}  ${ipGeo.city || '-'}, ${ipGeo.region || '-'}, ${ipGeo.country || '-'}`;
            } catch (e) {
                ipGeo = null;
                ipInfoEl.textContent = 'tidak tersedia (fetch gagal)';
                console.warn('IP geolocation fetch failed', e);
            }
        };

        const generateRandomCode = () => {
            const chars = 'ABCDE?#$$$FGHIJKLMN$$**##OPQR$#?!*STUV#WXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        };

        // Edit Mode Management Functions
        const activateGlobalEditMode = () => {
            isGlobalEditMode = true;
            document.body.classList.add('global-edit-mode');
            updateEditButtons();
            
            // Render ulang tabel yang sedang aktif
            if (!document.getElementById('inputRingkas').classList.contains('hidden')) {
                renderRingkasTable();
            }
            if (!document.getElementById('inputDetail').classList.contains('hidden')) {
                renderDetailTable();
            }
            
            // Jika popup supplierMaster terbuka, render ulang
            if (document.getElementById('supplierMasterPopup').classList.contains('active')) {
                renderSupplierMasterTable();
            }
            
            console.log('Global Edit Mode: AKTIF');
        };

        const deactivateGlobalEditMode = () => {
            isGlobalEditMode = false;
            document.body.classList.remove('global-edit-mode');
            updateEditButtons();
            
            // Render ulang tabel yang sedang aktif
            if (!document.getElementById('inputRingkas').classList.contains('hidden')) {
                renderRingkasTable();
            }
            if (!document.getElementById('inputDetail').classList.contains('hidden')) {
                renderDetailTable();
            }
            
            // Jika popup supplierMaster terbuka, render ulang
            if (document.getElementById('supplierMasterPopup').classList.contains('active')) {
                renderSupplierMasterTable();
            }
            
            console.log('Global Edit Mode: NONAKTIF');
        };

        const updateEditButtons = () => {
            const editRingkasBtn = document.getElementById('editBatchRingkas');
            const editDetailBtn = document.getElementById('editBatchDetail');
            const editSupplierMasterBtn = document.getElementById('editBatchSupplierMaster');
            
            if (isGlobalEditMode) {
                if (editRingkasBtn) {
                    editRingkasBtn.innerHTML = '<i class="fas fa-save"></i> Simpan';
                    editRingkasBtn.classList.remove('btn-primary');
                    editRingkasBtn.classList.add('btn-success');
                }
                if (editDetailBtn) {
                    editDetailBtn.innerHTML = '<i class="fas fa-save"></i> Simpan';
                    editDetailBtn.classList.remove('btn-primary');
                    editDetailBtn.classList.add('btn-success');
                }
                if (editSupplierMasterBtn) {
                    editSupplierMasterBtn.innerHTML = '<i class="fas fa-save"></i> Simpan';
                    editSupplierMasterBtn.classList.remove('btn-primary');
                    editSupplierMasterBtn.classList.add('btn-success');
                }
            } else {
                if (editRingkasBtn) {
                    editRingkasBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editRingkasBtn.classList.remove('btn-success');
                    editRingkasBtn.classList.add('btn-primary');
                }
                if (editDetailBtn) {
                    editDetailBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editDetailBtn.classList.remove('btn-success');
                    editDetailBtn.classList.add('btn-primary');
                }
                if (editSupplierMasterBtn) {
                    editSupplierMasterBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Batch';
                    editSupplierMasterBtn.classList.remove('btn-success');
                    editSupplierMasterBtn.classList.add('btn-primary');
                }
            }
        };

        const saveAllChanges = async () => {
            let success = true;
            let totalChanges = 0;
            
            // Hitung total perubahan sebelum penyimpanan
            totalChanges = batchChanges.ringkas.size + batchChanges.detail.size + batchChanges.supplierMaster.size;
            
            if (totalChanges === 0) {
                return { success: true, totalChanges: 0 };
            }
            
            console.log(`Menyimpan ${totalChanges} perubahan...`);

            // Simpan perubahan ringkas
            if (batchChanges.ringkas.size > 0) {
                try {
                    await updateRingkasBatch(batchChanges.ringkas);
                    console.log('Perubahan ringkas berhasil disimpan');
                } catch (error) {
                    console.error("Error saving ringkas batch:", error);
                    success = false;
                }
            }
            
            // Simpan perubahan detail
            if (batchChanges.detail.size > 0) {
                try {
                    await updateSalesBatch(batchChanges.detail);
                    console.log('Perubahan detail berhasil disimpan');
                } catch (error) {
                    console.error("Error saving detail batch:", error);
                    success = false;
                }
            }
            
            // Simpan perubahan supplier master
            if (batchChanges.supplierMaster.size > 0) {
                try {
                    await updateSupplierMasterBatch(batchChanges.supplierMaster);
                    console.log('Perubahan supplier master berhasil disimpan');
                } catch (error) {
                    console.error("Error saving supplier master batch:", error);
                    success = false;
                }
            }
            
            // Hapus batchChanges hanya jika semua penyimpanan berhasil
            if (success) {
                batchChanges.ringkas.clear();
                batchChanges.detail.clear();
                batchChanges.supplierMaster.clear();
            }
            
            return { success, totalChanges };
        };

        // Real-time Listeners
        const setupRealTimeListeners = () => {
            let salesQuery = db.collection('sales');
            if (userRole === 'Karyawan') {
                salesQuery = salesQuery.where('createdBy', '==', currentUser.uid);
            }
            
            // PERBAIKAN: Mengurutkan berdasarkan createdAt descending
            salesQuery.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                salesData = [];
                snapshot.forEach(doc => {
                    salesData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                if (!document.getElementById('inputRingkas').classList.contains('hidden')) {
                    renderRingkasTable();
                }
                if (!document.getElementById('inputDetail').classList.contains('hidden')) {
                    renderDetailTable();
                }
                if (!document.getElementById('inputSupplier').classList.contains('hidden')) {
                    renderSupplierTable();
                }
                if (!document.getElementById('laporanRingkas').classList.contains('hidden')) {
                    updateLaporanRingkas();
                }
            });

            let supplierQuery = db.collection('belumDibayar');
            if (userRole === 'Karyawan') {
                supplierQuery = supplierQuery.where('createdBy', '==', currentUser.uid);
            }
            
            supplierQuery.orderBy('tanggal', 'desc').onSnapshot(snapshot => {
                belumDibayarData = [];
                snapshot.forEach(doc => {
                    belumDibayarData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                if (document.getElementById('supplierInfoPopup').classList.contains('active')) {
                    renderSupplierDetailTable();
                }
            });

            // Real-time listener untuk supplierMaster dengan filter berdasarkan user
            let supplierMasterQuery = db.collection('supplierMaster');
            if (userRole === 'Karyawan') {
                supplierMasterQuery = supplierMasterQuery.where('createdBy', '==', currentUser.uid);
            }
            
            // PERBAIKAN: Mengurutkan berdasarkan createdAt descending
            supplierMasterQuery.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                supplierMasterData = [];
                snapshot.forEach(doc => {
                    supplierMasterData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                if (document.getElementById('supplierMasterPopup').classList.contains('active')) {
                    renderSupplierMasterTable();
                }
            });

            // Real-time listener untuk absensi
            let absensiQuery = db.collection('absensi');
            absensiQuery = absensiQuery.where('createdBy', '==', currentUser.uid);
            
            absensiQuery.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                const absensiData = [];
                snapshot.forEach(doc => {
                    absensiData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                if (!document.getElementById('inputAbsensi').classList.contains('hidden')) {
                    renderAbsensiTable(absensiData);
                }
            });
        };

        // UI Rendering Functions
        const updateTableZoom = tableType => {
            const table = document.getElementById(tableType === 'supplierPopup' ? 'tableSupplierDetail' : `table${capitalizeFirstLetter(tableType)}`);
            if (table) {
                table.style.transform = `scale(${currentZoomLevels[tableType]})`;
                table.style.transformOrigin = 'top left';
            }
        };

        const setupTableZoom = () => {
            const zoomConfigs = [
                { in: 'zoomInRingkas', out: 'zoomOutRingkas', type: 'ringkas' },
                { in: 'zoomInSupplier', out: 'zoomOutSupplier', type: 'supplier' }
            ];

            zoomConfigs.forEach(config => {
                const zoomInBtn = document.getElementById(config.in);
                const zoomOutBtn = document.getElementById(config.out);
                
                if (zoomInBtn && zoomOutBtn) {
                    zoomInBtn.addEventListener('click', () => {
                        if (currentZoomLevels[config.type] < maxZoomLevel) {
                            currentZoomLevels[config.type] += zoomStep;
                            updateTableZoom(config.type);
                        }
                    });
                    
                    zoomOutBtn.addEventListener('click', () => {
                        if (currentZoomLevels[config.type] > minZoomLevel) {
                            currentZoomLevels[config.type] -= zoomStep;
                            updateTableZoom(config.type);
                        }
                    });
                }
            });
        };

        const setupSearchFunctionality = () => {
            const searchConfigs = [
                { input: 'searchRingkas', table: 'tableRingkas', cols: [0, 1] },
                { input: 'searchDetail', table: 'tableDetail', cols: [2, 3], isInput: true },
                { input: 'searchSupplier', table: 'tableSupplier', cols: [0] }
            ];

            searchConfigs.forEach(config => {
                const searchInput = document.getElementById(config.input);
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const rows = document.querySelectorAll(`#${config.table} tbody tr`);
                        
                        rows.forEach(row => {
                            let match = false;
                            config.cols.forEach(colIndex => {
                                const cell = config.isInput ? 
                                    row.cells[colIndex].querySelector('input') : 
                                    row.cells[colIndex];
                                
                                if (cell) {
                                    const cellValue = config.isInput ? 
                                        cell.value.toLowerCase() : 
                                        cell.textContent.toLowerCase();
                                    
                                    if (cellValue.includes(searchTerm)) match = true;
                                }
                            });
                            row.style.display = match ? '' : 'none';
                        });
                    });
                }
            });
        };

        const setupCurrencyInputs = () => {
            document.addEventListener('blur', function(e) {
                if (e.target.classList.contains('currency-input-field')) {
                    const value = e.target.value.replace(/\D/g, '');
                    if (value) e.target.value = formatNumber(value);
                }
            }, true);
            
            document.addEventListener('focus', function(e) {
                if (e.target.classList.contains('currency-input-field')) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                }
            }, true);
        };

        const renderRingkasTable = () => {
            const tbody = document.querySelector('#tableRingkas tbody');
            tbody.innerHTML = '';
            
            const dataHariIni = getTodaySalesData();
            
            if (dataHariIni.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Belum ada data penjualan hari ini</td></tr>';
                return;
            }
            
            const groupedData = {};
            dataHariIni.forEach(item => {
                const key = `${item.supplier}-${item.barang}`;
                if (!groupedData[key]) {
                    groupedData[key] = { supplier: item.supplier, barang: item.barang, stok: 0, sisa: 0 };
                }
                groupedData[key].stok += item.stok;
                groupedData[key].sisa += item.sisa;
            });
            
            Object.values(groupedData).forEach(item => {
                const row = document.createElement('tr');
                const key = `${item.supplier}-${item.barang}`;
                const isReadOnly = !isGlobalEditMode;
                
                // Cek apakah ada perubahan di batchChanges.ringkas
                let displayStok = item.stok;
                let displaySisa = item.sisa;
                
                if (batchChanges.ringkas.has(key)) {
                    const changes = batchChanges.ringkas.get(key);
                    displayStok = changes.stok;
                    displaySisa = changes.sisa;
                }
                
                row.innerHTML = `
                    <td>${item.supplier}</td>
                    <td>${item.barang}</td>
                    <td><input type="number" class="number-input" value="${displayStok}" data-key="${key}" data-field="stok" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="number" class="number-input" value="${displaySisa}" data-key="${key}" data-field="sisa" ${isReadOnly ? 'readonly' : ''}></td>
                `;
                tbody.appendChild(row);
            });
            
            if (isGlobalEditMode) {
                setupRingkasInputListeners(tbody);
            }
        };

        const setupRingkasInputListeners = (container) => {
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    const key = this.getAttribute('data-key');
                    const field = this.getAttribute('data-field');
                    const value = parseInt(this.value) || 0;
                    
                    if (!batchChanges.ringkas.has(key)) {
                        const [supplier, barang] = key.split('-');
                        const dataHariIni = getTodaySalesData();
                        const matchingSales = dataHariIni.filter(item => 
                            item.supplier === supplier && item.barang === barang
                        );
                        
                        let stok = matchingSales.reduce((sum, item) => sum + item.stok, 0);
                        let sisa = matchingSales.reduce((sum, item) => sum + item.sisa, 0);
                        
                        batchChanges.ringkas.set(key, { stok, sisa });
                    }
                    
                    const data = batchChanges.ringkas.get(key);
                    data[field] = value;
                    batchChanges.ringkas.set(key, data);
                    
                    console.log(`Perubahan ringkas: ${key} - ${field} = ${value}`);
                });
            });
        };

        const renderDetailTable = () => {
            const tbody = document.querySelector('#tableDetail tbody');
            tbody.innerHTML = '';
            
            // PERBAIKAN: Data sudah diurutkan dari Firestore berdasarkan createdAt descending
            const dataHariIni = getTodaySalesData();
            
            if (dataHariIni.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Belum ada data penjualan hari ini</td></tr>';
                return;
            }
            
            dataHariIni.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Gunakan data dari batchChanges jika ada
                let itemData = { ...item };
                if (batchChanges.detail.has(item.id)) {
                    itemData = batchChanges.detail.get(item.id);
                }
                
                const terjual = itemData.stok - itemData.sisa;
                const uangSupplier = terjual * itemData.hargaBeli;
                const isReadOnly = !isGlobalEditMode;
                
                row.innerHTML = `
                    <td class="action-column">
                        <button class="btn btn-danger btn-hapus" title="Hapus entri" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    <td><input type="date" value="${itemData.tanggal}" data-id="${item.id}" data-field="tanggal" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="text" value="${itemData.supplier || ''}" data-id="${item.id}" data-field="supplier" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="text" value="${itemData.barang || ''}" data-id="${item.id}" data-field="barang" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="number" value="${itemData.stok || 0}" data-id="${item.id}" data-field="stok" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="number" value="${itemData.sisa || 0}" data-id="${item.id}" data-field="sisa" ${isReadOnly ? 'readonly' : ''}></td>
                    <td>${terjual}</td>
                    <td><input type="text" class="currency-input-field" value="${formatNumber(itemData.hargaBeli || 0)}" data-id="${item.id}" data-field="hargaBeli" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="text" class="currency-input-field" value="${formatNumber(itemData.hargaJual || 0)}" data-id="${item.id}" data-field="hargaJual" ${isReadOnly ? 'readonly' : ''}></td>
                    <td>${formatCurrency(uangSupplier)}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (isGlobalEditMode) {
                setupDetailInputListeners(tbody);
            }
            
            tbody.querySelectorAll('.btn-hapus').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('Apakah Anda yakin ingin menghapus entri ini?')) {
                        try {
                            await deleteSale(id);
                        } catch (error) {
                            console.error("Error deleting sale:", error);
                            alert("Gagal menghapus data: " + error.message);
                        }
                    }
                });
            });
        };

        const setupDetailInputListeners = (container) => {
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    const id = this.getAttribute('data-id');
                    const field = this.getAttribute('data-field');
                    let value = this.value;
                    
                    if (field === 'hargaBeli' || field === 'hargaJual') {
                        value = parseCurrency(value);
                    } else if (field === 'stok' || field === 'sisa') {
                        value = parseInt(value) || 0;
                    } else if (field === 'tanggal') {
                        // Validasi tanggal
                        if (!value) {
                            value = getToday();
                        }
                    }
                    
                    if (!batchChanges.detail.has(id)) {
                        const sale = salesData.find(item => item.id === id);
                        if (sale) {
                            batchChanges.detail.set(id, { ...sale });
                        }
                    }
                    
                    const data = batchChanges.detail.get(id);
                    data[field] = value;
                    batchChanges.detail.set(id, data);
                    
                    console.log(`Perubahan detail: ${id} - ${field} = ${value}`);
                });
            });
        };

        const renderSupplierTable = () => {
            const tbody = document.querySelector('#tableSupplier tbody');
            tbody.innerHTML = '';
            
            const dataHariIni = getTodaySalesData();
            
            if (dataHariIni.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">Belum ada data supplier hari ini</td></tr>';
                return;
            }
            
            const supplierTotals = {};
            dataHariIni.forEach(item => {
                const terjual = item.stok - item.sisa;
                const uangSupplier = terjual * item.hargaBeli;
                
                if (!supplierTotals[item.supplier]) supplierTotals[item.supplier] = 0;
                supplierTotals[item.supplier] += uangSupplier;
            });
            
            Object.entries(supplierTotals).forEach(([supplier, total]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier}</td>
                    <td>${formatCurrency(total)}</td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderSupplierDetailTable = () => {
            const tbody = document.querySelector('#tableSupplierDetail tbody');
            tbody.innerHTML = '';
            
            if (belumDibayarData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Belum ada data supplier detail</td></tr>';
                return;
            }
            
            belumDibayarData.forEach((item) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="action-column">
                        <button class="btn btn-danger btn-hapus" title="Hapus entri" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    <td><input type="date" value="${item.tanggal}" data-id="${item.id}" data-field="tanggal"></td>
                    <td><input type="text" value="${item.nama || ''}" data-id="${item.id}" data-field="nama"></td>
                    <td><input type="text" class="currency-input-field" value="${formatNumber(item.belumDibayar || 0)}" data-id="${item.id}" data-field="belumDibayar"></td>
                `;
                tbody.appendChild(row);
            });
            
            tbody.querySelectorAll('.btn-hapus').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('Apakah Anda yakin ingin menghapus entri ini?')) {
                        try {
                            await deleteSupplierPayment(id);
                        } catch (error) {
                            console.error("Error deleting supplier payment:", error);
                            alert("Gagal menghapus data: " + error.message);
                        }
                    }
                });
            });
            
            tbody.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', async function() {
                    const id = this.getAttribute('data-id');
                    const field = this.getAttribute('data-field');
                    let value = this.value;
                    
                    if (field === 'belumDibayar') {
                        value = parseCurrency(value);
                    }
                    
                    try {
                        const updateData = { [field]: value };
                        await db.collection('belumDibayar').doc(id).update(updateData);
                    } catch (error) {
                        console.error("Error updating supplier payment:", error);
                        alert("Gagal memperbarui data: " + error.message);
                    }
                });
            });
        };

        const renderSupplierMasterTable = () => {
            const tbody = document.querySelector('#tableSupplierMaster tbody');
            tbody.innerHTML = '';
            
            if (supplierMasterData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Belum ada data master supplier</td></tr>';
                return;
            }
            
            // PERBAIKAN: Data sudah diurutkan dari Firestore berdasarkan createdAt descending
            // Jadi tidak perlu sorting tambahan di sini
            supplierMasterData.forEach((item, index) => {
                const isSelected = selectedSupplierIds.has(item.id);
                const isReadOnly = !isGlobalEditMode;
                
                // Gunakan data dari batchChanges jika ada
                let itemData = { ...item };
                if (batchChanges.supplierMaster.has(item.id)) {
                    itemData = batchChanges.supplierMaster.get(item.id);
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="supplier-checkbox" data-id="${item.id}" ${isSelected ? 'checked' : ''} data-index="${index}">
                    </td>
                    <td><input type="text" value="${itemData.nama || ''}" data-id="${item.id}" data-field="nama" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="text" value="${itemData.barang || ''}" data-id="${item.id}" data-field="barang" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="text" class="currency-input-field" value="${formatNumber(itemData.hargaBeli || 0)}" data-id="${item.id}" data-field="hargaBeli" ${isReadOnly ? 'readonly' : ''}></td>
                    <td><input type="text" class="currency-input-field" value="${formatNumber(itemData.hargaJual || 0)}" data-id="${item.id}" data-field="hargaJual" ${isReadOnly ? 'readonly' : ''}></td>
                    <td class="action-column">
                        <button class="btn btn-danger btn-hapus-supplier" title="Hapus" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            tbody.querySelectorAll('.supplier-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    if (this.checked) {
                        selectedSupplierIds.add(id);
                        // PERBAIKAN: Simpan urutan pemilihan
                        const index = parseInt(this.getAttribute('data-index'));
                        if (!selectedSupplierOrder.includes(id)) {
                            selectedSupplierOrder.push(id);
                        }
                    } else {
                        selectedSupplierIds.delete(id);
                        // Hapus dari urutan pemilihan
                        selectedSupplierOrder = selectedSupplierOrder.filter(itemId => itemId !== id);
                    }
                });
            });
            
            tbody.querySelectorAll('.btn-hapus-supplier').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.getAttribute('data-id');
                    if (confirm('Apakah Anda yakin ingin menghapus supplier ini?')) {
                        try {
                            await deleteSupplierMaster(id);
                            selectedSupplierIds.delete(id);
                            selectedSupplierOrder = selectedSupplierOrder.filter(itemId => itemId !== id);
                        } catch (error) {
                            console.error("Error deleting supplier master:", error);
                            alert("Gagal menghapus data: " + error.message);
                        }
                    }
                });
            });
            
            if (isGlobalEditMode) {
                setupSupplierMasterInputListenersForBatch(tbody);
            } else {
                setupSupplierMasterInputListenersForInstant(tbody);
            }
        };

        const setupSupplierMasterInputListenersForBatch = (container) => {
            container.querySelectorAll('input[type="text"]').forEach(input => {
                input.removeEventListener('blur', handleSupplierMasterBlurInstant);
                input.addEventListener('input', handleSupplierMasterInputBatch);
            });
        };

        const handleSupplierMasterInputBatch = function() {
            const id = this.getAttribute('data-id');
            const field = this.getAttribute('data-field');
            let value = this.value;
            
            if (field === 'hargaBeli' || field === 'hargaJual') {
                value = parseCurrency(value);
            }
            
            if (!batchChanges.supplierMaster.has(id)) {
                const supplier = supplierMasterData.find(item => item.id === id);
                if (supplier) {
                    batchChanges.supplierMaster.set(id, { ...supplier });
                }
            }
            
            const data = batchChanges.supplierMaster.get(id);
            data[field] = value;
            batchChanges.supplierMaster.set(id, data);
            
            console.log(`Perubahan supplier master (batch): ${id} - ${field} = ${value}`);
        };

        const setupSupplierMasterInputListenersForInstant = (container) => {
            container.querySelectorAll('input[type="text"]').forEach(input => {
                input.removeEventListener('input', handleSupplierMasterInputBatch);
                input.addEventListener('blur', handleSupplierMasterBlurInstant);
            });
        };

        const handleSupplierMasterBlurInstant = async function() {
            const id = this.getAttribute('data-id');
            const field = this.getAttribute('data-field');
            let value = this.value;
            
            if (field === 'hargaBeli' || field === 'hargaJual') {
                value = parseCurrency(value);
            }
            
            try {
                await updateSupplierMaster(id, { [field]: value });
            } catch (error) {
                console.error("Error updating supplier master:", error);
                alert("Gagal memperbarui data: " + error.message);
            }
        };

        const updateLaporanRingkas = () => {
            const filteredSales = getFilteredSalesData();
            
            let totalTerjual = 0, totalOmzet = 0, totalLabaKotor = 0;
            
            const karyawanData = {};
            
            filteredSales.forEach(item => {
                totalTerjual += item.terjual || 0;
                totalOmzet += item.omzet || 0;
                totalLabaKotor += item.labaKotor || 0;
                
                const createdBy = item.createdBy;
                const namaKaryawan = item.nama || `Karyawan ${createdBy.substring(0, 5)}...`;
                
                if (!karyawanData[createdBy]) {
                    karyawanData[createdBy] = {
                        nama: namaKaryawan,
                        omzet: 0,
                        labaKotor: 0,
                        totalTerjual: 0
                    };
                }
                
                karyawanData[createdBy].omzet += item.omzet || 0;
                karyawanData[createdBy].labaKotor += item.labaKotor || 0;
                karyawanData[createdBy].totalTerjual += item.terjual || 0;
            });
            
            document.getElementById('totalTerjual').textContent = formatNumber(totalTerjual);
            document.getElementById('totalOmzet').textContent = formatCurrency(totalOmzet);
            document.getElementById('totalLabaKotor').textContent = formatCurrency(totalLabaKotor);
            
            const karyawanCards = document.getElementById('karyawanCards');
            karyawanCards.innerHTML = '';
            
            Object.values(karyawanData).forEach(karyawan => {
                const card = document.createElement('div');
                card.className = 'data-card';
                card.innerHTML = `
                    <h3>${karyawan.nama}</h3>
                    <div class="data-item">
                        <span class="data-label">Omzet</span>
                        <span class="data-value">${formatCurrency(karyawan.omzet)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Laba Kotor</span>
                        <span class="data-value">${formatCurrency(karyawan.labaKotor)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Total Terjual</span>
                        <span class="data-value">${formatNumber(karyawan.totalTerjual)} Item</span>
                    </div>
                `;
                karyawanCards.appendChild(card);
            });
        };

        // Absensi Rendering Functions - DIPERBARUI untuk filter bulan ini
        const renderAbsensiTable = async (absensiData) => {
            absensiLogTable.innerHTML = '';
            
            if (!absensiData || absensiData.length === 0) {
                absensiLogTable.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Belum ada data absensi bulan ini</td></tr>';
                return;
            }
            
            // Filter data hanya untuk bulan ini
            const currentMonth = getCurrentMonth(); // Format: "YYYY-MM"
            const filteredData = absensiData.filter(record => {
                let recordMonth = null;
                if (record.tanggal) {
                    recordMonth = record.tanggal.slice(0, 7); // Ambil "YYYY-MM" dari tanggal
                } else if (record.createdAt) {
                    let date;
                    if (record.createdAt.seconds) {
                        date = new Date(record.createdAt.seconds * 1000);
                    } else {
                        date = new Date(record.createdAt);
                    }
                    recordMonth = date.toISOString().slice(0, 7);
                }
                return recordMonth === currentMonth;
            });
            
            if (filteredData.length === 0) {
                absensiLogTable.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Belum ada data absensi bulan ini</td></tr>';
                return;
            }
            
            // Urutkan berdasarkan tanggal terbaru
            filteredData.sort((a, b) => {
                const timeA = a.createdAt ? (a.createdAt.seconds || new Date(a.createdAt).getTime()/1000) : 0;
                const timeB = b.createdAt ? (b.createdAt.seconds || new Date(b.createdAt).getTime()/1000) : 0;
                return timeB - timeA;
            });
            
            filteredData.forEach((r, i) => {
                const tr = document.createElement('tr');
                const flagsText = (r.flags && r.flags.length) ? r.flags.join('; ') : '';
                
                // Tentukan class CSS untuk status
                let statusClass = '';
                let statusText = '';
                if (r.status === 'tepat') {
                    statusClass = 'absensi-tepat';
                    statusText = 'Tepat';
                } else if (r.status === 'terlambat') {
                    statusClass = 'absensi-terlambat';
                    statusText = 'Terlambat';
                } else {
                    statusClass = 'absensi-invalid';
                    statusText = 'Invalid';
                }
                
                // Format waktu
                let waktuFormatted = '-';
                if (r.createdAt) {
                    const waktuServer = r.createdAt.seconds ? new Date(r.createdAt.seconds * 1000) : new Date(r.createdAt);
                    waktuFormatted = waktuServer.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false
                    });
                }
                
                // Format tanggal
                let tanggalFormatted = '-';
                if (r.tanggal) {
                    tanggalFormatted = r.tanggal;
                } else if (r.createdAt) {
                    const date = r.createdAt.seconds ? new Date(r.createdAt.seconds * 1000) : new Date(r.createdAt);
                    tanggalFormatted = formatDate(date);
                }
                
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td>${tanggalFormatted}</td>
                    <td>${waktuFormatted}</td>
                    <td class="${statusClass}">${statusText} ${r.jenis ? `(${r.jenis})` : ''}</td>
                    <td>${r.latitude ? r.latitude.toFixed(6) : '-'}, ${r.longitude ? r.longitude.toFixed(6) : '-'}</td>
                    <td>${r.distance_m || '-'}</td>
                    <td>${r.accuracy !== null && r.accuracy !== undefined ? r.accuracy.toFixed(1) : '-'}</td>
                    <td>${r.ip || '-'}</td>
                    <td>${flagsText ? '<span class="absensi-flag">'+flagsText+'</span>' : '<span class="absensi-ok">ok</span>'}</td>
                `;
                absensiLogTable.appendChild(tr);
            });
        };

        const updateAbsensiStatus = (message, type = 'info') => {
            absensiStatus.textContent = message;
            absensiStatus.className = 'absensi-status';
            
            if (type === 'success') {
                absensiStatus.classList.add('absensi-ok');
            } else if (type === 'error') {
                absensiStatus.classList.add('absensi-invalid');
            } else if (type === 'warning') {
                absensiStatus.classList.add('absensi-terlambat');
            }
        };

        // Admin Geofence Functions
        const togglePeriodeInputs = () => {
            periodeInputs.style.display = filterPeriode.value === 'periode' ? 'flex' : 'none';
            renderLaporanKehadiranAdmin();
        };

        const hapusLogBulanLalu = async () => {
            if (!confirm('Yakin hapus semua log bulan lalu?')) return;
            
            const today = new Date();
            const firstDayOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            try {
                const snapshot = await db.collection('absensi')
                    .where('createdAt', '<', firstDayOfCurrentMonth)
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                alert(`Berhasil menghapus ${snapshot.size} dokumen bulan lalu`);
                // Refresh data
                await getAllAbsensiData();
                renderLaporanKehadiranAdmin();
            } catch (error) {
                console.error('Error menghapus log:', error);
                alert('Gagal menghapus log: ' + error.message);
            }
        };

        const renderLaporanKehadiranAdmin = async () => {
            try {
                logTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Memuat data...</td></tr>';
                
                // Tunggu sampai data selesai dimuat
                if (allAbsensiData.length === 0) {
                    await getAllAbsensiData();
                }
                
                let filteredData = [...allAbsensiData];
                
                // Filter nama dari field 'nama' di koleksi absensi
                const namaFilter = filterNama.value;
                if (namaFilter) {
                    filteredData = filteredData.filter(item => item.nama === namaFilter);
                }
                
                // Filter periode
                const periode = filterPeriode.value;
                const now = new Date();
                
                if (periode === 'hari_ini') {
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filteredData = filteredData.filter(item => {
                        const itemDate = item.createdAt ? new Date(item.createdAt.seconds * 1000) : new Date(item.tanggal);
                        return itemDate >= startOfDay;
                    });
                } else if (periode === 'bulan_ini') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredData = filteredData.filter(item => {
                        const itemDate = item.createdAt ? new Date(item.createdAt.seconds * 1000) : new Date(item.tanggal);
                        return itemDate >= startOfMonth;
                    });
                } else if (periode === 'periode') {
                    if (startDate.value && endDate.value) {
                        const start = new Date(startDate.value);
                        const end = new Date(endDate.value);
                        end.setHours(23, 59, 59, 999);
                        filteredData = filteredData.filter(item => {
                            const itemDate = item.createdAt ? new Date(item.createdAt.seconds * 1000) : new Date(item.tanggal);
                            return itemDate >= start && itemDate <= end;
                        });
                    }
                }
                
                // Sort by date descending
                filteredData.sort((a, b) => {
                    const timeA = a.createdAt ? (a.createdAt.seconds || new Date(a.createdAt).getTime()/1000) : 0;
                    const timeB = b.createdAt ? (b.createdAt.seconds || new Date(b.createdAt).getTime()/1000) : 0;
                    return timeB - timeA;
                });
                
                // Render tabel
                logTableBody.innerHTML = '';
                let index = 1;
                
                filteredData.forEach(item => {
                    const tr = document.createElement('tr');
                    
                    // Format tanggal dan waktu
                    let tanggalFormatted = '-';
                    let waktuFormatted = '-';
                    
                    if (item.createdAt) {
                        const date = item.createdAt.seconds ? 
                            new Date(item.createdAt.seconds * 1000) : 
                            new Date(item.createdAt);
                        tanggalFormatted = date.toLocaleDateString('id-ID');
                        waktuFormatted = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    } else if (item.tanggal) {
                        tanggalFormatted = item.tanggal;
                    }
                    
                    // Tentukan status
                    let statusText = item.status || '-';
                    if (item.jenis) {
                        statusText += ` (${item.jenis})`;
                    }
                    
                    // Link foto
                    const fotoLink = item.foto_url ? 
                        `<a href="${item.foto_url}" target="_blank" title="Lihat Foto"></a>` : '-';
                    
                    tr.innerHTML = `
                        <td>${index++}</td>
                        <td>${tanggalFormatted}</td>
                        <td>${waktuFormatted}</td>
                        <td>${item.nama || '-'}</td>
                        <td>${statusText}</td>
                        <td>${fotoLink}</td>
                    `;
                    logTableBody.appendChild(tr);
                });
                
                if (index === 1) {
                    logTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Tidak ada data absensi untuk filter yang dipilih</td></tr>';
                }
                
                // Isi filter nama dengan nama-nama unik dari data absensi
                if (filterNama.options.length <= 1) {
                    const uniqueNames = [...new Set(allAbsensiData.map(item => item.nama).filter(Boolean))];
                    filterNama.innerHTML = '<option value="">Semua</option>';
                    uniqueNames.forEach(nama => {
                        const option = document.createElement('option');
                        option.value = nama;
                        option.textContent = nama;
                        filterNama.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('Error render laporan kehadiran:', error);
                logTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Error memuat data: ' + error.message + '</td></tr>';
            }
        };

        const downloadCSV = async () => {
            try {
                // Gunakan data yang sudah difilter
                let filteredData = [...allAbsensiData];
                
                // Filter nama
                const namaFilter = filterNama.value;
                if (namaFilter) {
                    filteredData = filteredData.filter(item => item.nama === namaFilter);
                }
                
                // Filter periode
                const periode = filterPeriode.value;
                const now = new Date();
                
                if (periode === 'hari_ini') {
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filteredData = filteredData.filter(item => {
                        const itemDate = item.createdAt ? new Date(item.createdAt.seconds * 1000) : new Date(item.tanggal);
                        return itemDate >= startOfDay;
                    });
                } else if (periode === 'bulan_ini') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filteredData = filteredData.filter(item => {
                        const itemDate = item.createdAt ? new Date(item.createdAt.seconds * 1000) : new Date(item.tanggal);
                        return itemDate >= startOfMonth;
                    });
                } else if (periode === 'periode') {
                    if (startDate.value && endDate.value) {
                        const start = new Date(startDate.value);
                        const end = new Date(endDate.value);
                        end.setHours(23, 59, 59, 999);
                        filteredData = filteredData.filter(item => {
                            const itemDate = item.createdAt ? new Date(item.createdAt.seconds * 1000) : new Date(item.tanggal);
                            return itemDate >= start && itemDate <= end;
                        });
                    }
                }
                
                // Konversi ke CSV - hanya kolom yang diminta: Tanggal, Nama, Status, Waktu, URL Foto
                const csvHeader = ['Tanggal', 'Waktu', 'Nama', 'Status', 'Foto URL'];
                const csvData = [];
                
                filteredData.forEach((item) => {
                    let tanggalFormatted = '-';
                    let waktuFormatted = '-';
                    
                    if (item.createdAt) {
                        const date = item.createdAt.seconds ? 
                            new Date(item.createdAt.seconds * 1000) : 
                            new Date(item.createdAt);
                        tanggalFormatted = date.toLocaleDateString('id-ID');
                        waktuFormatted = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    } else if (item.tanggal) {
                        tanggalFormatted = item.tanggal;
                    }
                    
                    const statusText = item.status ? `${item.status} ${item.jenis ? `(${item.jenis})` : ''}` : '-';
                    
                    csvData.push([
                        tanggalFormatted,
                        waktuFormatted,
                        item.nama || '-',
                        statusText,
                        item.foto_url || '-'
                    ]);
                });
                
                // Konversi ke CSV string
                let csvContent = csvHeader.join(',') + '\n';
                csvData.forEach(row => {
                    csvContent += row.map(field => `"${field}"`).join(',') + '\n';
                });
                
                // Download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `laporan_kehadiran_${timestamp}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error download CSV:', error);
                alert('Gagal mengunduh CSV: ' + error.message);
            }
        };

        const setupAdminGeofenceListeners = () => {
            // Initialize dates
            const today = new Date().toISOString().split('T')[0];
            if (startDate) startDate.value = today;
            if (endDate) endDate.value = today;
            
            // Event listeners
            if (deleteLogBtn) {
                deleteLogBtn.addEventListener('click', hapusLogBulanLalu);
            }
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadCSV);
            }
            
            if (filterPeriode) {
                filterPeriode.addEventListener('change', togglePeriodeInputs);
            }
            
            if (filterNama) {
                filterNama.addEventListener('change', renderLaporanKehadiranAdmin);
            }
            
            if (filterPeriode) {
                filterPeriode.addEventListener('change', renderLaporanKehadiranAdmin);
            }
            
            if (startDate) {
                startDate.addEventListener('change', renderLaporanKehadiranAdmin);
            }
            
            if (endDate) {
                endDate.addEventListener('change', renderLaporanKehadiranAdmin);
            }
        };

        const updateTabNavigation = (contentId, defaultTab) => {
            tabNavigation.innerHTML = '';
            currentTabs = [];
            
            if (contentId === 'inputPenjualan') {
                currentTabs = ['ringkas', 'detail', 'supplier'];
                tabNavigation.style.display = 'flex';
                
                currentTabs.forEach(tab => {
                    const tabElement = document.createElement('div');
                    tabElement.className = `tab ${tab === (defaultTab || 'ringkas') ? 'active' : ''}`;
                    tabElement.textContent = getTabLabel(tab);
                    tabElement.setAttribute('data-tab', tab);
                    
                    tabElement.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tabElement.classList.add('active');
                        
                        allContentSections.forEach(section => section.classList.add('hidden'));
                        
                        const contentToShow = document.getElementById(`input${capitalizeFirstLetter(tab)}`);
                        if (contentToShow) {
                            contentToShow.classList.remove('hidden');
                            
                            const renderFunctions = {
                                'ringkas': renderRingkasTable,
                                'detail': renderDetailTable,
                                'supplier': renderSupplierTable
                            };
                            
                            if (renderFunctions[tab]) renderFunctions[tab]();
                        }
                    });
                    
                    tabNavigation.appendChild(tabElement);
                });
                
                const defaultTabContent = document.getElementById(`input${capitalizeFirstLetter(defaultTab || 'ringkas')}`);
                if (defaultTabContent) {
                    defaultTabContent.classList.remove('hidden');
                    if (defaultTab === 'ringkas') renderRingkasTable();
                }
            } else {
                tabNavigation.style.display = 'none';
            }
        };

        const setupTambahEntri = () => {
            if (tambahEntriBtn) {
                tambahEntriBtn.addEventListener('click', async function() {
                    const today = getToday();
                    
                    const newItem = {
                        tanggal: today,
                        supplier: '',
                        barang: '',
                        stok: 0,
                        sisa: 0,
                        hargaBeli: 0,
                        hargaJual: 0
                    };
                    
                    try {
                        await addSale(newItem);
                    } catch (error) {
                        console.error("Error adding sale:", error);
                        alert("Gagal menambah data: " + error.message);
                    }
                });
            }
        };

        const setupEditModeButtons = () => {
            const editBatchRingkas = document.getElementById('editBatchRingkas');
            const editBatchDetail = document.getElementById('editBatchDetail');
            const editBatchSupplierMaster = document.getElementById('editBatchSupplierMaster');
            
            if (editBatchRingkas) {
                editBatchRingkas.addEventListener('click', async function() {
                    if (!isGlobalEditMode) {
                        // Aktifkan mode edit global
                        activateGlobalEditMode();
                        alert('Mode edit aktif. Klik tombol "Simpan" di tab manapun untuk menyimpan semua perubahan.');
                    } else {
                        // Simpan semua perubahan
                        const { success, totalChanges } = await saveAllChanges();
                        if (success) {
                            deactivateGlobalEditMode();
                            if (totalChanges > 0) {
                                alert(`Berhasil menyimpan ${totalChanges} perubahan.`);
                            } else {
                                alert('Tidak ada perubahan yang perlu disimpan.');
                            }
                        } else {
                            alert('Gagal menyimpan perubahan. Silakan coba lagi.');
                        }
                    }
                });
            }
            
            if (editBatchDetail) {
                editBatchDetail.addEventListener('click', async function() {
                    if (!isGlobalEditMode) {
                        // Aktifkan mode edit global
                        activateGlobalEditMode();
                        alert('Mode edit aktif. Klik tombol "Simpan" di tab manapun untuk menyimpan semua perubahan.');
                    } else {
                        // Simpan semua perubahan
                        const { success, totalChanges } = await saveAllChanges();
                        if (success) {
                            deactivateGlobalEditMode();
                            if (totalChanges > 0) {
                                alert(`Berhasil menyimpan ${totalChanges} perubahan.`);
                            } else {
                                alert('Tidak ada perubahan yang perlu disimpan.');
                            }
                        } else {
                            alert('Gagal menyimpan perubahan. Silakan coba lagi.');
                        }
                    }
                });
            }
            
            if (editBatchSupplierMaster) {
                editBatchSupplierMaster.addEventListener('click', async function() {
                    if (!isGlobalEditMode) {
                        // Aktifkan mode edit global
                        activateGlobalEditMode();
                        alert('Mode edit aktif. Klik tombol "Simpan" di tab manapun untuk menyimpan semua perubahan.');
                    } else {
                        // Simpan semua perubahan
                        const { success, totalChanges } = await saveAllChanges();
                        if (success) {
                            deactivateGlobalEditMode();
                            if (totalChanges > 0) {
                                alert(`Berhasil menyimpan ${totalChanges} perubahan.`);
                            } else {
                                alert('Tidak ada perubahan yang perlu disimpan.');
                            }
                        } else {
                            alert('Gagal menyimpan perubahan. Silakan coba lagi.');
                        }
                    }
                });
            }
        };

        const setupSupplierPopup = () => {
            const infoSupplierBtn = document.getElementById('infoSupplierBtn');
            const supplierInfoPopup = document.getElementById('supplierInfoPopup');
            const closeSupplierInfo = document.getElementById('closeSupplierInfo');
            const tambahEntriSupplier = document.getElementById('tambahEntriSupplier');
            
            if (infoSupplierBtn) {
                infoSupplierBtn.addEventListener('click', () => {
                    supplierInfoPopup.classList.add('active');
                    renderSupplierDetailTable();
                });
            }
            
            if (closeSupplierInfo) {
                closeSupplierInfo.addEventListener('click', () => {
                    supplierInfoPopup.classList.remove('active');
                });
            }
            
            if (tambahEntriSupplier) {
                tambahEntriSupplier.addEventListener('click', async function() {
                    const today = getToday();
                    
                    const newItem = {
                        tanggal: today,
                        nama: '',
                        belumDibayar: 0
                    };
                    
                    try {
                        await addSupplierPayment(newItem);
                    } catch (error) {
                        console.error("Error adding supplier payment:", error);
                        alert("Gagal menambah data: " + error.message);
                    }
                });
            }
            
            window.addEventListener('click', (e) => {
                if (e.target === supplierInfoPopup) {
                    supplierInfoPopup.classList.remove('active');
                }
            });
        };

        const setupSupplierMasterPopup = () => {
            const supplierPopupDetail = document.getElementById('supplierPopupDetail');
            const supplierMasterPopup = document.getElementById('supplierMasterPopup');
            const closeSupplierMaster = document.getElementById('closeSupplierMaster');
            const tambahSupplierMaster = document.getElementById('tambahSupplierMaster');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const pasteSelectedSupplier = document.getElementById('pasteSelectedSupplier');
            const deleteSelectedSupplier = document.getElementById('deleteSelectedSupplier');
            
            if (supplierPopupDetail) {
                supplierPopupDetail.addEventListener('click', async () => {
                    await getSupplierMaster();
                    supplierMasterPopup.classList.add('active');
                    renderSupplierMasterTable();
                });
            }
            
            if (closeSupplierMaster) {
                closeSupplierMaster.addEventListener('click', () => {
                    supplierMasterPopup.classList.remove('active');
                    selectedSupplierIds.clear();
                    selectedSupplierOrder = [];
                });
            }
            
            if (tambahSupplierMaster) {
                tambahSupplierMaster.addEventListener('click', async function() {
                    const newItem = {
                        nama: '',
                        barang: '',
                        hargaBeli: 0,
                        hargaJual: 0
                    };
                    
                    try {
                        await addSupplierMaster(newItem);
                    } catch (error) {
                        console.error("Error adding supplier master:", error);
                        alert("Gagal menambah data: " + error.message);
                    }
                });
            }
            
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.supplier-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        const id = checkbox.getAttribute('data-id');
                        const index = parseInt(checkbox.getAttribute('data-index'));
                        if (this.checked) {
                            selectedSupplierIds.add(id);
                            if (!selectedSupplierOrder.includes(id)) {
                                selectedSupplierOrder.push(id);
                            }
                        } else {
                            selectedSupplierIds.delete(id);
                            selectedSupplierOrder = selectedSupplierOrder.filter(itemId => itemId !== id);
                        }
                    });
                });
            }
            
            if (pasteSelectedSupplier) {
                pasteSelectedSupplier.addEventListener('click', async function() {
                    if (selectedSupplierIds.size === 0) {
                        alert('Pilih minimal satu supplier untuk dipaste.');
                        return;
                    }
                    
                    const today = getToday();
                    
                    // PERBAIKAN PENTING: Menggunakan selectedSupplierOrder untuk menjaga urutan
                    // Dapatkan supplier berdasarkan urutan pemilihan
                    const selectedSuppliers = [];
                    selectedSupplierOrder.forEach(id => {
                        const supplier = supplierMasterData.find(item => item.id === id);
                        if (supplier) {
                            selectedSuppliers.push(supplier);
                        }
                    });
                    
                    let successCount = 0;
                    // PERBAIKAN: Menggunakan reverse() agar yang dipilih pertama muncul di atas
                    // Karena data di detail diurutkan dari terbaru ke terlama
                    for (const supplier of selectedSuppliers.reverse()) {
                        const newItem = {
                            tanggal: today,
                            supplier: supplier.nama || '',
                            barang: supplier.barang || '',
                            stok: 0,
                            sisa: 0,
                            hargaBeli: supplier.hargaBeli || 0,
                            hargaJual: supplier.hargaJual || 0
                        };
                        
                        try {
                            await addSale(newItem);
                            successCount++;
                        } catch (error) {
                            console.error("Error adding sale from supplier:", error);
                        }
                    }
                    
                    alert(`Berhasil menambahkan ${successCount} entri dari supplier.`);
                    supplierMasterPopup.classList.remove('active');
                    selectedSupplierIds.clear();
                    selectedSupplierOrder = [];
                });
            }
            
            if (deleteSelectedSupplier) {
                deleteSelectedSupplier.addEventListener('click', async function() {
                    if (selectedSupplierIds.size === 0) {
                        alert('Pilih minimal satu supplier untuk dihapus.');
                        return;
                    }
                    
                    if (confirm(`Apakah Anda yakin ingin menghapus ${selectedSupplierIds.size} supplier?`)) {
                        try {
                            await deleteSupplierMasterBatch(Array.from(selectedSupplierIds));
                            selectedSupplierIds.clear();
                            selectedSupplierOrder = [];
                            alert('Supplier berhasil dihapus.');
                        } catch (error) {
                            console.error("Error deleting supplier batch:", error);
                            alert("Gagal menghapus supplier: " + error.message);
                        }
                    }
                });
            }
            
            window.addEventListener('click', (e) => {
                if (e.target === supplierMasterPopup) {
                    supplierMasterPopup.classList.remove('active');
                    selectedSupplierIds.clear();
                    selectedSupplierOrder = [];
                }
            });
        };

        const setupLaporanRingkasFilterListeners = () => {
            const periodeSelect = document.getElementById('periodeRingkas');
            const tanggalMulai = document.getElementById('tanggalMulaiRingkas');
            const tanggalSelesai = document.getElementById('tanggalSelesaiRingkas');
            
            const updateLaporan = () => updateLaporanRingkas();
            
            if (periodeSelect) {
                periodeSelect.addEventListener('change', function() {
                    const customPeriodRingkas = document.getElementById('customPeriodRingkas');
                    const customPeriodRingkas2 = document.getElementById('customPeriodRingkas2');
                    
                    if (this.value === 'custom') {
                        customPeriodRingkas.classList.remove('hidden');
                        customPeriodRingkas2.classList.remove('hidden');
                    } else {
                        customPeriodRingkas.classList.add('hidden');
                        customPeriodRingkas2.classList.add('hidden');
                    }
                    updateLaporan();
                });
            }
            
            if (tanggalMulai) {
                tanggalMulai.addEventListener('change', updateLaporan);
            }
            
            if (tanggalSelesai) {
                tanggalSelesai.addEventListener('change', updateLaporan);
            }
        };

        // Absensi Event Handlers - DIPERBARUI untuk kompresi 20KB
        const handlePhotoCapture = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        // Kompres gambar terlebih dahulu dengan batas maksimal 20KB
                        updateAbsensiStatus('Mengompres foto (maksimal 20KB)...', 'info');
                        const compressedImage = await compressImage(file, 20);
                        currentPhoto = compressedImage;
                        photoPreview.src = currentPhoto;
                        photoPreview.style.display = 'block';
                        updateAbsensiStatus('Foto berhasil diambil dan dikompres (di bawah 20KB). Klik "Absen Sekarang" untuk melanjutkan.', 'success');
                        
                        // Aktifkan tombol absen setelah foto berhasil diambil
                        absenBtn.disabled = false;
                    } catch (error) {
                        console.error("Error compressing image:", error);
                        updateAbsensiStatus('Gagal mengompres foto: ' + error.message, 'error');
                        currentPhoto = null;
                        photoPreview.style.display = 'none';
                        absenBtn.disabled = true;
                    }
                };
                reader.readAsDataURL(file);
            }
            // Reset input
            cameraInput.value = '';
        };

        const doAbsen = async () => {
            // Validasi 1: Cek apakah foto sudah diambil
            if (!currentPhoto) {
                updateAbsensiStatus('Harap ambil foto terlebih dahulu sebelum absen.', 'error');
                return;
            }

            // Validasi 2: Cek sudah presensi hari ini
            const sudahPresensi = await sudahPresensiHariIni();
            if (sudahPresensi) {
                updateAbsensiStatus('Anda sudah melakukan presensi hari ini. Hanya diperbolehkan sekali presensi per hari.', 'error');
                return;
            }

            // Validasi 3: Cek waktu presensi
            const waktuValidasi = validasiWaktuPresensi();
            if (!waktuValidasi.valid) {
                updateAbsensiStatus(waktuValidasi.message, 'error');
                return;
            }

            if (!navigator.geolocation) {
                updateAbsensiStatus('Geolocation tidak didukung browser.', 'error');
                return;
            }
            
            // Nonaktifkan tombol selama proses
            absenBtn.disabled = true;
            takePhotoBtn.disabled = true;
            
            // Mulai countdown 25 detik dengan efek profesional
            let countdown = 25;
            const gimmickMessages = [
                "Menginisialisasi sistem absensi...",
                "Memulai deteksi lokasi...",
                "Memeriksa koneksi jaringan...",
                "Memverifikasi perangkat...",
                "Menganalisis lingkungan...",
                "Memproses data geolokasi...",
                "Memvalidasi keamanan...",
                "Checking Lokasi Palsu...",
                "Mencatat laporan...",
                "Menyiapkan log sistem...",
                "Mengenkripsi data...",
                "Melakukan final check..."
            ];
            
            let messageIndex = 0;
            
            // Clear interval sebelumnya jika ada
            if (randomCodeInterval) {
                clearInterval(randomCodeInterval);
            }
            
            randomCodeInterval = setInterval(() => {
                countdown--;
                
                // Update message setiap 2-3 detik
                if (countdown % 2 === 0 && messageIndex < gimmickMessages.length) {
                    updateAbsensiStatus(
                        gimmickMessages[messageIndex] + ` (${countdown}s)`
                    );
                    randomCodeEl.textContent = `[${generateRandomCode()}]`;
                    messageIndex++;
                } else {
                    updateAbsensiStatus(
                        `Proses absensi sedang berjalan... (${countdown}s)`
                    );
                    randomCodeEl.textContent = `[${generateRandomCode()}]`;
                }
                
                if (countdown <= 0) {
                    clearInterval(randomCodeInterval);
                    randomCodeEl.textContent = '';
                    updateAbsensiStatus('Meminta lokasi...', 'info');
                    
                    // Mulai proses geolocation setelah countdown
                    setTimeout(() => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => onPositionSuccess(pos, waktuValidasi.data), 
                            onPositionError, 
                            { 
                                enableHighAccuracy: true, 
                                maximumAge: 0, 
                                timeout: 30000 
                            }
                        );
                    }, 500);
                }
            }, 1000);
        };

        // *** PERBAIKAN UTAMA: Proses upload foto & simpan hanya jika di dalam radius ***
        const onPositionSuccess = async (pos, waktuPresensi) => {
            // Validasi ulang: cek apakah sudah presensi hari ini
            const sudahPresensi = await sudahPresensiHariIni();
            if (sudahPresensi) {
                updateAbsensiStatus('Anda sudah melakukan presensi hari ini. Hanya diperbolehkan sekali presensi per hari.', 'error');
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;
                return;
            }

            // Validasi ulang: cek waktu presensi
            const waktuValidasi = validasiWaktuPresensi();
            if (!waktuValidasi.valid) {
                updateAbsensiStatus(waktuValidasi.message, 'error');
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;
                return;
            }

            // Validasi ulang: cek foto
            if (!currentPhoto) {
                updateAbsensiStatus('Foto tidak ditemukan. Harap ambil foto ulang.', 'error');
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;
                return;
            }

            // Validasi ulang: cek apakah kantorLocation sudah dimuat
            if (!kantorLocation || !kantorLocation.lokasiCabang) {
                updateAbsensiStatus('Lokasi kantor belum diatur. Silakan hubungi admin.', 'error');
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;
                return;
            }

            const coords = pos.coords;
            const clientTs = pos.timestamp || Date.now();
            const latitude = coords.latitude;
            const longitude = coords.longitude;
            const accuracy = coords.accuracy || null;
            const altitude = coords.altitude || null;
            const heading = coords.heading || null;
            const speed = coords.speed || null;

            const kantorLat = kantorLocation.lokasiCabang.lat;
            const kantorLon = kantorLocation.lokasiCabang.lon;
            const kantorRadius = kantorLocation.lokasiCabang.radius || 100;

            const dist = distanceMeters(latitude, longitude, kantorLat, kantorLon);
            const flags = [];

            // Heuristik: akurasi buruk
            if (accuracy && accuracy > 100) flags.push('accuracy_poor');

            // Heuristik: akurasi sangat kecil
            if (accuracy && accuracy < 5) flags.push('accuracy_very_high_possible_spoof');

            // Heuristik: timestamp mismatch
            const now = Date.now();
            if (Math.abs(now - clientTs) > 5 * 60 * 1000) flags.push('timestamp_mismatch');

            // Heuristik: IP geolocation mismatch
            if (ipGeo && ipGeo.lat && ipGeo.lon) {
                const ipDist = distanceMeters(latitude, longitude, parseFloat(ipGeo.lat), parseFloat(ipGeo.lon));
                if (ipDist > 50000) flags.push('ip_geo_mismatch');
            }

            // Validasi radius - menggunakan lokasi kantor user yang sesuai
            const inside = dist <= kantorRadius;

            // *** PERBAIKAN: Jika di luar radius, batalkan seluruh proses ***
            if (!inside) {
                updateAbsensiStatus(`Anda berada di luar radius (${Math.round(dist)} m dari kantor). Presensi tidak dapat dilakukan.`, 'error');
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;
                currentPhoto = null; // Reset foto agar tidak terpakai
                photoPreview.style.display = 'none';
                return;
            }

            // --- Hanya lanjutkan jika inside = true ---
            // Upload foto
            let fotoUrl = null;
            if (currentPhoto) {
                try {
                    updateAbsensiStatus('Mengupload foto (maksimal 20KB)...', 'info');
                    fotoUrl = await uploadToCloudinary(currentPhoto);
                } catch (error) {
                    console.error("Error uploading photo:", error);
                    flags.push('photo_upload_failed');
                }
            }

            // Prepare record
            const record = {
                tanggal: formatDate(new Date()),
                waktu: new Date().toISOString(),
                status: waktuPresensi.status,
                jenis: waktuPresensi.jenis,
                latitude, 
                longitude, 
                accuracy, 
                altitude, 
                heading, 
                speed,
                distance_m: Math.round(dist),
                inside_radius: inside,
                kantor_lat: kantorLat,
                kantor_lon: kantorLon,
                kantor_radius: kantorRadius,
                ip: ipGeo ? ipGeo.ip : null,
                ip_lat: ipGeo ? ipGeo.lat : null,
                ip_lon: ipGeo ? ipGeo.lon : null,
                foto_url: fotoUrl,
                flags,
                user_agent: navigator.userAgent
            };

            try {
                // Save to Firestore
                await addAbsensi(record);
                
                // Aktifkan kembali tombol
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;

                // UI feedback
                if (flags.length > 0) {
                    updateAbsensiStatus(`Absensi ${waktuPresensi.status} berhasil (flagged): ${flags.join(', ')}`, 'warning');
                } else {
                    updateAbsensiStatus(`Absensi ${waktuPresensi.status} berhasil! Jarak ${Math.round(dist)} m dari kantor Anda.`, 'success');
                }

                // Reset foto setelah digunakan
                currentPhoto = null;
                photoPreview.style.display = 'none';
                absenBtn.disabled = true; // Nonaktifkan kembali tombol absen
                
                // Refresh tabel absensi
                const absensiData = await getAbsensiData();
                renderAbsensiTable(absensiData);
                
            } catch (error) {
                console.error("Error saving absensi:", error);
                updateAbsensiStatus('Gagal menyimpan data absensi: ' + error.message, 'error');
                absenBtn.disabled = false;
                takePhotoBtn.disabled = false;
            }
        };

        const onPositionError = (err) => {
            updateAbsensiStatus('Gagal mendapatkan lokasi: ' + err.message, 'error');
            absenBtn.disabled = false;
            takePhotoBtn.disabled = false;
        };

        const setupAbsensiListeners = () => {
            if (absenBtn) {
                absenBtn.addEventListener('click', doAbsen);
            }
            
            if (takePhotoBtn) {
                takePhotoBtn.addEventListener('click', () => cameraInput.click());
            }
            
            if (cameraInput) {
                cameraInput.addEventListener('change', handlePhotoCapture);
            }
        };

        const initializeAbsensi = async () => {
            try {
                // Nonaktifkan tombol absen sampai foto diambil
                absenBtn.disabled = true;
                
                // Load kantor location berdasarkan user
                await getKantorLocation();
                
                // Tampilkan info lokasi kantor
                if (kantorLocation && kantorLocation.lokasiCabang) {
                    lokasiKantorInfo.textContent = 
                        `${kantorLocation.lokasiCabang.lat}, ${kantorLocation.lokasiCabang.lon} - Radius: ${kantorLocation.lokasiCabang.radius}m`;
                    if (kantorLocation.namaCabang) {
                        lokasiKantorInfo.textContent = `${kantorLocation.namaCabang} - ` + lokasiKantorInfo.textContent;
                    }
                } else {
                    lokasiKantorInfo.textContent = 'Lokasi kantor belum diatur. Silakan hubungi admin.';
                }
                
                // Load IP geolocation
                await fetchIpGeo();
                
                // Load absensi data
                const absensiData = await getAbsensiData();
                renderAbsensiTable(absensiData);
                
                setupAbsensiListeners();
                
                // Cek apakah sudah presensi hari ini
                const sudahPresensi = await sudahPresensiHariIni();
                if (sudahPresensi) {
                    updateAbsensiStatus('Anda sudah melakukan presensi hari ini. Hanya diperbolehkan sekali presensi per hari.', 'info');
                }
            } catch (error) {
                console.error("Error initializing absensi:", error);
                updateAbsensiStatus('Gagal memuat data absensi: ' + error.message, 'error');
            }
        };

        const setupMenuBasedOnRole = () => {
            menuList.innerHTML = '';
            
            if (userRole === 'Karyawan') {
                menuList.innerHTML = `
                    <li class="menu-item" id="laporanPenjualan">
                        <span><i class="fas fa-chart-line"></i> Laporan Penjualan</span>
                        <i class="fas fa-chevron-down"></i>
                    </li>
                    <ul class="submenu" id="submenuPenjualan">
                        <li class="submenu-item" data-content="inputPenjualan" data-tab="ringkas">Input Penjualan</li>
                    </ul>
                    
                    <li class="menu-item" id="laporanAbsensi">
                        <span><i class="fas fa-calendar-check"></i> Laporan Absensi</span>
                        <i class="fas fa-chevron-down"></i>
                    </li>
                    <ul class="submenu" id="submenuAbsensi">
                        <li class="submenu-item" data-content="inputAbsensi">Input Absensi</li>
                    </ul>
                    
                    <li class="menu-item" id="switchMode">
                        <span><i class="fas fa-moon"></i> Mode Gelap</span>
                    </li>
                    <li class="menu-item" id="logout">
                        <span><i class="fas fa-sign-out-alt"></i> Logout</span>
                    </li>
                `;
            } else if (userRole === 'Admin') {
                menuList.innerHTML = `
                    <li class="menu-item" id="laporanPenjualanAdmin">
                        <span><i class="fas fa-chart-line"></i> Laporan Penjualan</span>
                        <i class="fas fa-chevron-down"></i>
                    </li>
                    <ul class="submenu" id="submenuPenjualanAdmin">
                        <li class="submenu-item" data-content="laporanRingkas">Laporan Ringkas</li>
                    </ul>
                    
                    <li class="menu-item" id="laporanAbsensiAdmin">
                        <span><i class="fas fa-calendar-check"></i> Laporan Absensi</span>
                        <i class="fas fa-chevron-down"></i>
                    </li>
                    <ul class="submenu" id="submenuAbsensiAdmin">
                        <li class="submenu-item" data-content="laporanKehadiranAdmin">Laporan Kehadiran</li>
                    </ul>
                    
                    <li class="menu-item" id="switchMode">
                        <span><i class="fas fa-moon"></i> Mode Gelap</span>
                    </li>
                    <li class="menu-item" id="logout">
                        <span><i class="fas fa-sign-out-alt"></i> Logout</span>
                    </li>
                `;
            }
            
            // Event listeners untuk menu karyawan
            const laporanPenjualan = document.getElementById('laporanPenjualan');
            const laporanAbsensi = document.getElementById('laporanAbsensi');
            const submenuPenjualan = document.getElementById('submenuPenjualan');
            const submenuAbsensi = document.getElementById('submenuAbsensi');
            
            if (laporanPenjualan) {
                laporanPenjualan.addEventListener('click', () => {
                    submenuPenjualan.classList.toggle('active');
                    laporanPenjualan.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
                });
            }
            
            if (laporanAbsensi) {
                laporanAbsensi.addEventListener('click', () => {
                    submenuAbsensi.classList.toggle('active');
                    laporanAbsensi.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
                });
            }
            
            // Event listeners untuk menu admin
            const laporanPenjualanAdmin = document.getElementById('laporanPenjualanAdmin');
            const laporanAbsensiAdmin = document.getElementById('laporanAbsensiAdmin');
            const submenuPenjualanAdmin = document.getElementById('submenuPenjualanAdmin');
            const submenuAbsensiAdmin = document.getElementById('submenuAbsensiAdmin');
            
            if (laporanPenjualanAdmin) {
                laporanPenjualanAdmin.addEventListener('click', () => {
                    submenuPenjualanAdmin.classList.toggle('active');
                    laporanPenjualanAdmin.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
                });
            }
            
            if (laporanAbsensiAdmin) {
                laporanAbsensiAdmin.addEventListener('click', () => {
                    submenuAbsensiAdmin.classList.toggle('active');
                    laporanAbsensiAdmin.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
                });
            }
            
            const switchMode = document.getElementById('switchMode');
            switchMode.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                if (document.body.classList.contains('dark-mode')) {
                    switchMode.innerHTML = '<span><i class="fas fa-sun"></i> Mode Terang</span>';
                } else {
                    switchMode.innerHTML = '<span><i class="fas fa-moon"></i> Mode Gelap</span>';
                }
            });
            
            const logout = document.getElementById('logout');
            logout.addEventListener('click', async () => {
                if (confirm('Apakah Anda yakin ingin logout?')) {
                    try {
                        await logoutUser();
                        mainHeader.classList.add('hidden');
                        mainContent.classList.add('hidden');
                        userInfo.classList.add('hidden');
                        loginPopup.classList.add('active');
                        loginForm.reset();
                    } catch (error) {
                        console.error("Logout error:", error);
                    }
                }
            });
            
            // Event listeners untuk semua submenu items
            const submenuItems = document.querySelectorAll('.submenu-item');
            submenuItems.forEach(item => {
                item.addEventListener('click', async () => {
                    const contentId = item.getAttribute('data-content');
                    const tab = item.getAttribute('data-tab');
                    
                    menuPopup.classList.remove('active');
                    allContentSections.forEach(section => section.classList.add('hidden'));
                    pageTitle.textContent = getPageTitle(contentId);
                    updateTabNavigation(contentId, tab);
                    
                    const contentSection = document.getElementById(contentId);
                    if (contentSection) {
                        contentSection.classList.remove('hidden');
                        
                        const renderFunctions = {
                            'inputPenjualan': () => {
                                renderRingkasTable();
                                renderDetailTable();
                                renderSupplierTable();
                            },
                            'laporanRingkas': updateLaporanRingkas,
                            'inputAbsensi': initializeAbsensi,
                            'laporanKehadiranAdmin': async () => {
                                await getAllAbsensiData();
                                renderLaporanKehadiranAdmin();
                                setupAdminGeofenceListeners();
                            }
                        };
                        
                        if (renderFunctions[contentId]) {
                            if (contentId === 'laporanKehadiranAdmin') {
                                await renderFunctions[contentId]();
                            } else {
                                renderFunctions[contentId]();
                            }
                        }
                    }
                    
                    // Tutup semua submenu
                    document.querySelectorAll('.submenu').forEach(sub => {
                        sub.classList.remove('active');
                    });
                    document.querySelectorAll('.fa-chevron-down').forEach(icon => {
                        icon.classList.remove('fa-chevron-up');
                    });
                });
            });
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    
                    try {
                        const userData = await getUserData(user.uid);
                        userRole = userData.role;
                        
                        currentUser.nama = userData.nama;
                        
                        userName.textContent = userData.nama;
                        userRoleElement.textContent = userRole;
                        userInfo.classList.remove('hidden');
                        
                        setupMenuBasedOnRole();
                        
                        await getSales();
                        await getSupplierPayments();
                        await getSupplierMaster();
                        
                        setupRealTimeListeners();
                        
                        loginPopup.classList.remove('active');
                        mainHeader.classList.remove('hidden');
                        mainContent.classList.remove('hidden');
                        
                    } catch (error) {
                        console.error("Error during auth state change:", error);
                        alert("Terjadi kesalahan: " + error.message);
                        await logoutUser();
                    }
                } else {
                    currentUser = null;
                    userRole = null;
                    mainHeader.classList.add('hidden');
                    mainContent.classList.add('hidden');
                    userInfo.classList.add('hidden');
                    loginPopup.classList.add('active');
                }
            });

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                loginBtn.classList.add('loading');
                loginText.innerHTML = '<span class="spinner"></span>Memproses...';
                loginFooter.textContent = 'Sedang masuk...';
                
                try {
                    await loginWithEmailPassword(email, password);
                } catch (error) {
                    console.error("Login error:", error);
                    loginFooter.textContent = 'Login gagal: ' + error.message;
                    loginBtn.classList.remove('loading');
                    loginText.textContent = 'Login';
                }
            });
            
            menuBtn.addEventListener('click', () => menuPopup.classList.add('active'));
            closeMenu.addEventListener('click', () => menuPopup.classList.remove('active'));
            window.addEventListener('click', (e) => { if (e.target === menuPopup) menuPopup.classList.remove('active'); });
            
            setupTambahEntri();
            setupEditModeButtons();
            setupSupplierPopup();
            setupSupplierMasterPopup();
            setupCurrencyInputs();
            setupSearchFunctionality();
            setupTableZoom();
            setupLaporanRingkasFilterListeners();
        });
    </script>
</body>
</html>